---
title: äº‹åŠ¡
metaDescription: 'æ¢ç´¢Prisma Clientäº‹åŠ¡å¤„ç†çš„æŠ€å·§'
tocDepth: 2
---

<TopBlock>

**äº‹åŠ¡**æ˜¯ä¸€ç³»åˆ—çš„æ“ä½œï¼Œåªæœ‰æ¯ä¸ªæ“ä½œå¤„ç†æˆåŠŸæ‰ä¼šæˆåŠŸã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ›´æ–° 200 ä¸ªç”¨æˆ·ï¼Œæ¯ä¸ªæ›´æ–°å¾—å¿…é¡»æˆåŠŸï¼Œå¦åˆ™æ‰€æœ‰çš„æ›´æ–°å°±ä¼šå›æ»šï¼Œäº‹åŠ¡å°±ç®—å¤±è´¥äº†ã€‚

<details><summary>äº‹åŠ¡æ‰€æä¾›çš„å®‰å…¨ä¿è¯é€šå¸¸ç”±ACIDç¼©å†™æ¥æ¦‚æ‹¬ã€‚</summary>

å¼€å‘äººå‘˜åˆ©ç”¨æ•°æ®åº“æä¾›çš„å®‰å…¨ä¿éšœï¼Œå°†æ“ä½œæ”¾åœ¨äº‹åŠ¡ä¸­ã€‚è¿™äº›ç‰¹æ€§é€šå¸¸ç”¨ ACID çš„ç¼©å†™æ¥æ¦‚æ‹¬ã€‚

- **åŸå­åŒ–**: ç¡®ä¿ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œæˆ–è€…å…¨éƒ¨å®Œæˆï¼Œæˆ–è€…å…¨éƒ¨ä¸å®Œæˆã€‚äº‹åŠ¡è¦ä¹ˆè¢«æˆåŠŸæäº¤ï¼Œè¦ä¹ˆè¢«ä¸­æ­¢å’Œå›æ»šã€‚
- **ä¸€è‡´æ€§**: ç¡®ä¿äº‹åŠ¡å‰åçš„æ•°æ®åº“çŠ¶æ€æ˜¯æœ‰æ•ˆçš„ï¼ˆå³ä»»ä½•å…³äºæ•°æ®çš„ç°æœ‰å®Œæ•´æ€§éƒ½è¢«ä¿æŒï¼‰ã€‚
- **éš”ç¦»æ€§**: ç¡®ä¿åŒæ—¶è¿è¡Œçš„äº‹åŠ¡å…·æœ‰ç›¸åŒçš„æ•ˆæœï¼Œå°±åƒå®ƒä»¬æ˜¯ä¸²è¡Œè¿è¡Œçš„ä¸€æ ·ã€‚
- **æŒä¹…æ€§**: ç¡®ä¿åœ¨äº‹åŠ¡æˆåŠŸåï¼Œä»»ä½•å†™å…¥çš„æ•°æ®éƒ½è¢«æŒä¹…æ€§åœ°å­˜å‚¨ã€‚

è™½ç„¶ä¸Šé¢çš„ç‰¹æ€§æ¯ä¸€ä¸ªéƒ½æœ‰å¾ˆå¤šæ¨¡ç³Šå’Œç»†å¾®çš„å·®åˆ«ï¼ˆä¾‹å¦‚ï¼Œä¸€è‡´æ€§å®é™…ä¸Šå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªåº”ç”¨å±‚çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ•°æ®åº“ç‰¹æ€§ï¼Œæˆ–è€…éš”ç¦»é€šå¸¸æ˜¯ä»¥æ›´å¼ºå’Œæ›´å¼±çš„éš”ç¦»çº§åˆ«æ¥ä¿è¯çš„ï¼‰ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œå®ƒä»¬å¯ä»¥ä½œä¸ºå¼€å‘äººå‘˜åœ¨è€ƒè™‘æ•°æ®åº“äº‹åŠ¡æ—¶çš„ä¸€ä¸ªå¾ˆå¥½çš„é«˜çº§å‡†åˆ™ã€‚

> "äº‹åŠ¡æ˜¯ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå…è®¸åº”ç”¨ç¨‹åºå‡è®¾æŸäº›å¹¶å‘é—®é¢˜ã€æŸäº›ç±»å‹çš„ç¡¬ä»¶ã€è½¯ä»¶æ•…éšœä¸å­˜åœ¨ã€‚ä¸€å¤§ç±»é”™è¯¯è¢«ç®€åŒ–ä¸ºä¸€ä¸ªç®€å•çš„äº‹åŠ¡ä¸­æ­¢ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦å†è¯•ä¸€æ¬¡å³å¯" **[è®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨](https://dataintensive.net/), [Martin Kleppmann](https://twitter.com/martinkl)**

</details>

Prisma Client æ”¯æŒå…­ç§ä¸åŒçš„äº‹åŠ¡å¤„ç†æ–¹å¼ï¼Œç”¨äºä¸‰ç§ä¸åŒçš„åœºæ™¯:

| åœºæ™¯       | å¯ç”¨æŠ€æœ¯                                                             |
| :--------- | :------------------------------------------------------------------- |
| ä¾èµ–å†™å…¥   | <ul><li>åµŒå¥—å†™æ³•</li></ul>                                           |
| ç‹¬ç«‹å†™å…¥   | <ul><li>`$transaction` API</li><li>æ‰¹é‡å¤„ç†</li></ul>                |
| è¯»ã€æ”¹ã€å†™ | <ul><li>å¼‚æ­¥æ“ä½œ</li><li>ä¹è§‚çš„å¹¶å‘æ§åˆ¶</li><li>äº¤äº’å¼äº‹åŠ¡</li></ul> |

ä½ é€‰æ‹©çš„æŠ€æœ¯å–å†³äºä½ çš„ç‰¹å®šç”¨ä¾‹ã€‚

> **Note**: åœ¨æœ¬æŒ‡å—ä¸­ï¼Œå¯¹æ•°æ®åº“çš„å†™å…¥åŒ…æ‹¬åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤æ•°æ®ã€‚

</TopBlock>

## ä¾èµ–å†™å…¥

åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œå†™å…¥è¢«è®¤ä¸ºæ˜¯ç›¸äº’**ä¾èµ–**çš„ã€‚

- æ“ä½œä¾èµ–äºå‰ä¸€ä¸ªæ“ä½œçš„ç»“æœï¼ˆä¾‹å¦‚ï¼Œæ•°æ®åº“ç”Ÿæˆä¸€ä¸ª ID)

æœ€å¸¸è§çš„æƒ…å†µæ˜¯åˆ›å»ºä¸€æ¡è®°å½•å¹¶ä½¿ç”¨ç”Ÿæˆçš„ ID æ¥åˆ›å»ºæˆ–æ›´æ–°ç›¸å…³çš„è®°å½•, æ¯”å¦‚ï¼š

- åˆ›å»ºä¸€ä¸ªç”¨æˆ·å’Œä¸¤ä¸ªç›¸å…³çš„åšå®¢æ–‡ç« ï¼ˆä¸€å¯¹å¤šå…³ç³»ï¼‰--åœ¨åˆ›å»ºåšå®¢æ–‡ç« ä¹‹å‰å¿…é¡»çŸ¥é“ä½œè€… ID
- åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿå¹¶åˆ†é…æˆå‘˜ï¼ˆå¤šå¯¹å¤šçš„å…³ç³»ï¼‰--åœ¨åˆ†é…æˆå‘˜ä¹‹å‰å¿…é¡»çŸ¥é“å›¢é˜Ÿ ID

ä¾èµ–æ€§çš„å†™å…¥å¿…é¡»ä¸€èµ·æˆåŠŸï¼Œä»¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¹¶é˜²æ­¢æ„å¤–çš„è¡Œä¸ºï¼Œå¦‚æ²¡æœ‰ä½œè€…çš„åšå®¢æ–‡ç« æˆ–æ²¡æœ‰æˆå‘˜çš„å›¢é˜Ÿã€‚

### åµŒå¥—å†™æ³•

Prisma å¯¹ä¾èµ–å†™å…¥çš„è§£å†³æ–¹æ¡ˆæ˜¯**åµŒå¥—å†™æ³•**ï¼Œé€šè¿‡`create`ã€ `update`å®ç°ã€‚ä¸‹é¢çš„åµŒå¥—å†™æ³•åˆ›å»ºä¸€ä¸ªç”¨æˆ·å’Œä¸¤ä¸ªåšå®¢æ–‡ç« ï¼š

```ts
const nestedWrite = await prisma.user.create({
  data: {
    email: 'imani@prisma.io',
    posts: {
      create: [
        { title: 'My first day at Prisma' },
        { title: 'How to configure a unique constraint in PostgreSQL' },
      ],
    },
  },
})
```

å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼ŒPrisma å°†å›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚åµŒå¥—å†™æ³•ç›®å‰ä¸æ”¯æŒé¡¶çº§çš„æ‰¹é‡æ“ä½œï¼Œå¦‚`client.user.deleteMany`å’Œ`client.user.updateMany`ã€‚

#### ä»€ä¹ˆæ—¶å€™ç”¨åµŒå¥—å†™æ³•

- âœ” ä½ æƒ³åŒæ—¶åˆ›å»ºä¸¤æ¡æˆ–æ›´å¤šä¸ ID ç›¸å…³çš„è®°å½•ï¼ˆä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ªåšå®¢æ–‡ç« å’Œä¸€ä¸ªç”¨æˆ·ï¼‰
- âœ” ä½ æƒ³åŒæ—¶æ›´æ–°å’Œåˆ›å»ºä¸ ID ç›¸å…³çš„è®°å½•ï¼ˆä¾‹å¦‚ï¼Œæ”¹å˜ä¸€ä¸ªç”¨æˆ·çš„åå­—å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„åšå®¢æ–‡ç« ï¼‰

<Tip>

å¦‚æœä½ [æå‰è®¡ç®—]IDs, ä½ å¯ä»¥é€‰æ‹©åµŒå¥—å†™æ³•æˆ–ä½¿ç”¨[`$transaction` API](#scenario-pre-computed-ids-and-the-transaction-api).

</Tip>

#### æƒ…æ™¯ï¼šæ³¨å†Œæµç¨‹

è€ƒè™‘ Slack æ³¨å†Œæµç¨‹:

1. åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿ
2. ä¸ºè¯¥å›¢é˜Ÿæ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·è‡ªåŠ¨æˆä¸ºè¯¥å›¢é˜Ÿçš„ç®¡ç†å‘˜

è¿™ç§æƒ…å†µå¯ä»¥ç”¨ä»¥ä¸‹æ¨¡å¼è¡¨ç¤º--ç”¨æˆ·å¯ä»¥å±äºè®¸å¤šå›¢é˜Ÿï¼Œè€Œå›¢é˜Ÿå¯ä»¥æœ‰è®¸å¤šç”¨æˆ·ï¼ˆå¤šå¯¹å¤šçš„å…³ç³»ï¼‰ï¼š

```prisma
model Team {
  id      Int    @id @default(autoincrement())
  name    String
  members User[] // Many team members
}

model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  teams Team[] // Many teams
}
```

æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç”¨æˆ·å¹¶å…³è”åˆ°è¯¥å›¢é˜Ÿï¼š

```ts
// åˆ›å»ºteam
const team = await prisma.team.create({
  data: {
    name: 'Aurora Adventures',
  },
})

// åˆ›å»ºuserï¼Œå¹¶å…³è”åˆ°team
const user = await prisma.user.create({
  data: {
    email: 'alice@prisma.io',
    team: {
      connect: {
        id: team.id,
      },
    },
  },
})
```

ç„¶è€Œï¼Œè¿™æ®µä»£ç æœ‰ä¸€ä¸ªé—®é¢˜--è€ƒè™‘ä»¥ä¸‹æƒ…å†µ:

1. åˆ›å»ºå›¢é˜ŸæˆåŠŸ - "Aurora Adventures"ç°åœ¨å·²è¢«å ç”¨
2. åˆ›å»ºå’Œè¿æ¥ç”¨æˆ·å¤±è´¥ - "Aurora Adventures"å›¢é˜Ÿå­˜åœ¨ï¼Œä½†æ²¡æœ‰ç”¨æˆ·
3. å†æ¬¡ç»å†æ³¨å†Œæµç¨‹å¹¶è¯•å›¾é‡æ–°åˆ›å»º "Aurora Adventures"å¤±è´¥ - è¯¥å›¢é˜Ÿå·²ç»å­˜åœ¨

åˆ›å»ºå›¢é˜Ÿå’Œæ·»åŠ ç”¨æˆ·åº”è¯¥æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œä½œä¸ºä¸€ä¸ª**æ•´ä½“æˆåŠŸæˆ–å¤±è´¥**ã€‚

ä¸ºäº†åœ¨ä½çº§åˆ«çš„æ•°æ®åº“å®¢æˆ·ç«¯ä¸­å®ç°åŸå­å†™å…¥ï¼Œä½ å¿…é¡»ç”¨`BEGIN`ã€`COMMIT`å’Œ`ROLLBACK`è¯­å¥æ¥åŒ…è£¹ä½ çš„æ’å…¥ã€‚Prisma Client ç”¨åµŒå¥—å†™æ³•è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸‹é¢çš„æŸ¥è¯¢åˆ›å»ºäº†ä¸€ä¸ªå›¢é˜Ÿï¼Œåˆ›å»ºäº†ä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å…³è”äº†è®°å½•:

```ts
const team = await prisma.team.create({
  data: {
    name: 'Aurora Adventures',
    members: {
      create: {
        email: 'alice@prisma.io',
      },
    },
  },
})
```

æ­¤å¤–ï¼Œå¦‚æœåœ¨ä»»ä½•æ—¶å€™å‘ç”Ÿé”™è¯¯ï¼ŒPrisma Client å°†å›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚

#### åµŒå¥—å†™æ³• FAQs

##### ä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½ä½¿ç”¨`$transaction` API æ¥è§£å†³åŒæ ·çš„é—®é¢˜ï¼Ÿ

`$transaction` API ä¸å…è®¸ä½ åœ¨ä¸åŒçš„æ“ä½œä¹‹é—´ä¼ é€’ IDã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ`createUserOperation.id`è¿˜ä¸èƒ½ä½¿ç”¨:

```ts highlight=12;delete
const createUserOperation = prisma.user.create({
  data: {
    email: 'ebony@prisma.io',
  },
})

const createTeamOperation = prisma.team.create({
  data: {
    name: 'Aurora Adventures',
    members: {
      connect: {
        id: createUserOperation.id, // ä¸å¯è¡Œ, å› ä¸ºIDè¿˜ä¸å­˜åœ¨
      },
    },
  },
})

await prisma.$transaction([createUserOperation, createTeamOperation])
```

##### Prisma Client åµŒå¥—å†™æ³•æ˜¯å¦æ”¯æŒçº§è”åˆ é™¤?

<Admonition type="warning">

åœ¨ [2.26.0](https://github.com/prisma/prisma/releases/tag/2.26.0) åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥ä½¿ç”¨**preview feature** [referential actions](../../concepts/components/prisma-schema/relations/referential-actions)è¿›è¡Œçº§è”åˆ é™¤ã€‚

</Admonition>

- ä½¿ç”¨`$transaction` API æ¥æ‰§è¡Œçº§è”åˆ é™¤ã€‚åˆ é™¤ä¸€ä¸ªå›¢é˜Ÿå’Œåˆ é™¤è¯¥å›¢é˜Ÿçš„æˆå‘˜å¹¶ä¸æ˜¯ä¾èµ–æ€§çš„å†™æ³• - å¦‚æœä½ çŸ¥é“è¯¥å›¢é˜Ÿçš„ IDï¼Œä½ å¯ä»¥åœ¨[ä¸€ä¸ª`$transaction`ä¸­æ‰§è¡Œè¿™ä¸¤ä¸ªæ“ä½œ](#scenario-privacy-legislation)
- [åœ¨æ•°æ®åº“å±‚é¢ä¸Šé…ç½®çº§è”åˆ é™¤](../database/advanced-database-tasks/cascading-deletes).

> **Note**: æˆ‘ä»¬æ­£åœ¨ç ”ç©¶åœ¨[schema å±‚é¢ä¸Šçº§è”åˆ é™¤](https://github.com/prisma/prisma/issues/2810)çš„æ”¯æŒã€‚

##### åµŒå¥—å†™æ³•æ”¯æŒåµŒå¥—æ›´æ–°ï¼Œä½†æ›´æ–°ä¸æ˜¯ä¾èµ–å†™å…¥ - æˆ‘åº”è¯¥ä½¿ç”¨`$transaction` API å—ï¼Ÿ

æ­£ç¡®çš„è¯´æ³•æ˜¯ï¼Œå› ä¸ºä½ çŸ¥é“å›¢é˜Ÿçš„ IDï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ª`$transaction`ä¸­ç‹¬ç«‹åœ°æ›´æ–°å›¢é˜Ÿå’Œå®ƒçš„å›¢é˜Ÿæˆå‘˜ã€‚ä¸‹é¢çš„ä¾‹å­åœ¨ä¸€ä¸ª`$transaction`ä¸­æ‰§è¡Œè¿™ä¸¤ä¸ªæ“ä½œ:

```ts
const updateTeam = prisma.team.update({
  where: {
    id: 1,
  },
  data: {
    name: 'Aurora Adventures Ltd',
  },
})

const updateUsers = prisma.user.updateMany({
  where: {
    teams: {
      some: {
        id: 1,
      },
    },
    name: {
      equals: null,
    },
  },
  data: {
    name: 'Unknown User',
  },
})

await prisma.$transaction([deleteUsers, updateTeam])
```

ç„¶è€Œï¼Œä½ å¯ä»¥ç”¨åµŒå¥—å†™æ³•è¾¾åˆ°åŒæ ·çš„æ•ˆæœ:

```ts
const updateTeam = await prisma.team.update({
  where: {
    id: 1,
  },
  data: {
    name: 'Aurora Adventures Ltd', // æ›´æ–° team åç§°
    members: {
      updateMany: {
        // æ›´æ–°æ²¡æœ‰åå­—çš„å›¢é˜Ÿæˆå‘˜
        data: {
          name: 'Unknown User',
        },
        where: {
          name: {
            equals: null,
          },
        },
      },
    },
  },
})
```

<!-- Performance optimization? -->

##### æˆ‘èƒ½å¦è¿›è¡Œå¤šæ¬¡åµŒå¥—å†™æ³• - ä¾‹å¦‚ï¼Œåˆ›å»ºä¸¤ä¸ªæ–°çš„å›¢é˜Ÿå¹¶åˆ†é…ç”¨æˆ·?

æ˜¯çš„ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªåœºæ™¯å’ŒæŠ€æœ¯çš„ç»„åˆ:

- åˆ›å»ºä¸€ä¸ªå›¢é˜Ÿå¹¶åˆ†é…ç”¨æˆ·æ˜¯ä¸€ä¸ªä¾èµ–æ€§çš„å†™å…¥ - ä½¿ç”¨åµŒå¥—å†™æ³•
- åŒæ—¶åˆ›å»ºæ‰€æœ‰çš„å›¢é˜Ÿå’Œç”¨æˆ·æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å†™å…¥ï¼Œå› ä¸ºå›¢é˜Ÿ/ç”¨æˆ·ç»„åˆ#1 å’Œå›¢é˜Ÿ/ç”¨æˆ·ç»„åˆ#2 æ˜¯ä¸ç›¸å…³çš„å†™å…¥ - ä½¿ç”¨`$transaction` API

```ts
// åµŒå¥—å†™æ³•
const createOne = prisma.team.create({
  data: {
    name: 'Aurora Adventures',
    members: {
      create: {
        email: 'alice@prisma.io',
      },
    },
  },
})

// åµŒå¥—å†™æ³•
const createTwo = prisma.team.create({
  data: {
    name: 'Cool Crew',
    members: {
      create: {
        email: 'elsa@prisma.io',
      },
    },
  },
})

// $transaction API
await prisma.$transaction([createTwo, createOne])
```

## ç‹¬ç«‹å†™å…¥

å¦‚æœå†™æ“ä½œä¸ä¾èµ–äºå‰ä¸€ä¸ªæ“ä½œçš„ç»“æœï¼Œåˆ™è¢«è®¤ä¸ºæ˜¯**ç‹¬ç«‹**çš„ã€‚ä»¥ä¸‹å‡ ç»„ç‹¬ç«‹çš„å†™æ“ä½œå¯ä»¥ä»¥ä»»ä½•é¡ºåºå‘ç”Ÿ

- å°†ä¸€ä¸ªè®¢å•åˆ—è¡¨çš„çŠ¶æ€å­—æ®µæ›´æ–°ä¸º "å·²å‘é€"
- å°†ä¸€ä¸ªç”µå­é‚®ä»¶åˆ—è¡¨æ ‡è®°ä¸º "å·²è¯»"

> **Note**: å¦‚æœå­˜åœ¨çº¦æŸæ¡ä»¶ï¼Œç‹¬ç«‹å†™å…¥å¯èƒ½å¿…é¡»ä»¥ç‰¹å®šçš„é¡ºåºå‘ç”Ÿ - ä¾‹å¦‚ï¼Œå¦‚æœå¸–å­æœ‰ä¸€ä¸ªå¼ºåˆ¶æ€§çš„`authorId`å­—æ®µï¼Œä½ å¿…é¡»åœ¨åšå®¢ä½œè€…ä¹‹å‰åˆ é™¤åšå®¢å¸–å­ã€‚ç„¶è€Œï¼Œå®ƒä»¬ä»ç„¶è¢«è®¤ä¸ºæ˜¯ç‹¬ç«‹çš„å†™å…¥ï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•æ“ä½œä¾èµ–äºå…ˆå‰æ“ä½œçš„ç»“æœï¼Œä¾‹å¦‚æ•°æ®åº“è¿”å›ä¸€ä¸ªç”Ÿæˆçš„ IDã€‚

æ ¹æ®ä½ çš„è¦æ±‚ï¼ŒPrisma Client æœ‰å››ä¸ªé€‰é¡¹æ¥å¤„ç†åº”è¯¥ä¸€èµ·æˆåŠŸæˆ–å¤±è´¥çš„ç‹¬ç«‹å†™å…¥ã€‚

### æ‰¹é‡æ“ä½œ

æ‰¹é‡å†™å…¥å…è®¸ä½ åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å†™å…¥å¤šä¸ªç›¸åŒç±»å‹çš„è®°å½•- å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼ŒPrisma ä¼šå›æ»šæ•´ä¸ªäº‹åŠ¡ï¼ŒPrisma ç›®å‰æ”¯æŒï¼š

- `updateMany`
- `deleteMany`

æ­£åœ¨è€ƒè™‘ [create and upsert in bulk](https://github.com/prisma/prisma-client-js/issues/332) çš„èƒ½åŠ›: f å¦‚æœä½ æœ‰å…´è¶£ï¼Œè¯·éšæ—¶æå‡ºä½ çš„ä½¿ç”¨æ¡ˆä¾‹å¹¶åŠ æ³¨ã€‚

#### ä½•æ—¶ä½¿ç”¨æ‰¹é‡æ“ä½œ

- âœ” ä½ æƒ³æ›´æ–°ä¸€æ‰¹ç›¸åŒç±»å‹çš„è®°å½•ï¼Œå¦‚ä¸€æ‰¹ç”µå­é‚®ä»¶

#### åœºæ™¯ï¼šå°†ç”µå­é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»

ä½ æ­£åœ¨å»ºç«‹ä¸€ä¸ªç±»ä¼¼äº gmail.com çš„æœåŠ¡ï¼Œä½ çš„å®¢æˆ·æƒ³è¦ä¸€ä¸ª "æ ‡è®°ä¸ºå·²è¯» "çš„åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·å°†æ‰€æœ‰çš„ç”µå­é‚®ä»¶æ ‡è®°ä¸ºå·²è¯»ã€‚å¯¹é‚®ä»¶çŠ¶æ€çš„æ¯ä¸€æ¬¡æ›´æ–°éƒ½æ˜¯ç‹¬ç«‹çš„å†™å…¥ï¼Œå› ä¸ºé‚®ä»¶ä¹‹é—´å¹¶ä¸ç›¸äº’ä¾èµ– - ä¾‹å¦‚ï¼Œ"ç”Ÿæ—¥å¿«ä¹ ğŸ°"çš„é‚®ä»¶ä¸å®œå®¶çš„ä¿ƒé”€é‚®ä»¶æ²¡æœ‰å…³ç³»ã€‚

åœ¨ä¸‹é¢çš„æ¨¡å¼ä¸­ï¼Œä¸€ä¸ª`User`å¯ä»¥æœ‰å¾ˆå¤šæ”¶åˆ°çš„é‚®ä»¶ï¼ˆä¸€å¯¹å¤šçš„å…³ç³»ï¼‰:

```ts
model User {
  id    Int       @id @default(autoincrement())
  email           String @unique
  receivedEmails  Email[] // Many emails
}

model Email {
  id      Int     @id @default(autoincrement())
  user    User    @relation(fields: [userId], references: [id])
  userId  Int
  subject String
  body    String
  unread  Boolean
}
```

åŸºäºè¿™ä¸ªæ¨¡å¼ï¼Œä½ å¯ä»¥ä½¿ç”¨`updateMany`æ¥æ ‡è®°æ‰€æœ‰æœªè¯»é‚®ä»¶ä¸ºå·²è¯»:

```ts
await prisma.email.updateMany({
  where: {
    user: {
      id: 10,
      unread: true,
    },
  },
  data: {
    unread: false,
  },
})
```

#### æˆ‘æ˜¯å¦å¯ä»¥åœ¨æ‰¹é‡æ“ä½œä¸­ä½¿ç”¨åµŒå¥—å†™æ³•?

ä¸è¡Œ - `updateMany` å’Œ `deleteMany` ç›®å‰éƒ½ä¸æ”¯æŒåµŒå¥—å†™æ³•ã€‚ä¾‹å¦‚ï¼Œä½ ä¸èƒ½åˆ é™¤å¤šä¸ªå›¢é˜Ÿå’Œä»–ä»¬æ‰€æœ‰çš„æˆå‘˜ï¼ˆçº§è”åˆ é™¤ï¼‰ï¼š:

```ts highlight=8;delete
await prisma.team.deleteMany({
  where: {
    id: {
      in: [2, 99, 2, 11],
    },
  },
  data: {
    members: {}, // æ— æ³•è®¿é—®è¿™é‡Œçš„members
  },
})
```

å¯ä»¥ä½¿ç”¨ [`$transaction` API æ‰§è¡Œçº§è”åˆ é™¤](#are-cascading-deletes-supported-by-the-prisma-client-nested-writes).

#### æˆ‘å¯ä»¥é€šè¿‡`$transaction` API æ¥ä½¿ç”¨æ‰¹é‡æ“ä½œå—?

å¯ä»¥ - ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ª`$transaction`ä¸­åŒ…å«å¤šä¸ª`deleteMany`æ“ä½œ

<!-- prettier-ignore -->
### <inlinecode>$transaction</inlinecode> API

`$transaction` API æ˜¯ç‹¬ç«‹å†™å…¥çš„é€šç”¨è§£å†³æ–¹æ¡ˆ, å…è®¸ä½ å°†å¤šä¸ªæ“ä½œä½œä¸ºä¸€ä¸ªå•ä¸€çš„åŸå­æ“ä½œæ¥è¿è¡Œ - å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼ŒPrisma ä¼šå›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚

è¿˜å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ“ä½œæ˜¯æ ¹æ®å®ƒä»¬åœ¨äº‹åŠ¡ä¸­çš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚

```ts
await prisma.$transaction([iRunFirst, iRunSecond, iRunThird])
```

> **Note**: åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨ä¸€ä¸ªæŸ¥è¯¢å¹¶ä¸å½±å“æŸ¥è¯¢æœ¬èº«çš„æ“ä½œé¡ºåºã€‚

éšç€ Prisma Client çš„å‘å±•ï¼Œ`$transaction` API çš„ä½¿ç”¨æƒ…å†µå°†è¶Šæ¥è¶Šå¤šåœ°è¢«æ›´ä¸“ä¸šçš„æ‰¹é‡æ“ä½œï¼ˆå¦‚ createManyï¼‰å’ŒåµŒå¥—å†™æ³•æ‰€å–ä»£

#### ä½•æ—¶ç”¨`$transaction` API

- âœ” æ‚¨æƒ³æ›´æ–°ä¸€ä¸ªåŒ…æ‹¬ä¸åŒç±»å‹è®°å½•ï¼ˆå¦‚ç”µå­é‚®ä»¶å’Œç”¨æˆ·ï¼‰çš„æ‰¹æ¬¡ã€‚è¿™äº›è®°å½•ä¸éœ€è¦ä»¥ä»»ä½•æ–¹å¼è¿›è¡Œå…³è”ã€‚
- âœ” æ‚¨æƒ³æ‰¹å¤„ç†åŸå§‹ SQL æŸ¥è¯¢ (`$executeRaw`) - ä¾‹å¦‚ï¼Œç”¨äº Prisma Client å°šä¸æ”¯æŒçš„åŠŸèƒ½ã€‚

#### åœºæ™¯: éšç§æ³•

GDPR å’Œå…¶ä»–éšç§æ³•è§„èµ‹äºˆç”¨æˆ·è¦æ±‚ä¸€ä¸ªç»„ç»‡åˆ é™¤å…¶æ‰€æœ‰ä¸ªäººæ•°æ®çš„æƒåˆ©ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹æ¨¡å¼ä¸­ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰è®¸å¤šå¸–å­å’Œç§äººä¿¡æ¯ï¼š

```prisma
model User {
  id              Int              @id @default(autoincrement())
  posts           Post[]
  privateMessages PrivateMessage[]
}

model Post {
  id      Int    @id @default(autoincrement())
  user    User   @relation(fields: [userId], references: [id])
  userId  Int
  title   String
  content String
}

model PrivateMessage {
  id      Int    @id @default(autoincrement())
  user    User   @relation(fields: [userId], references: [id])
  userId  Int
  message String
}
```

å¦‚æœç”¨æˆ·æƒ³åˆ æ‰ä½¿ç”¨è®°å½•, æˆ‘ä»¬å¿…é¡»åˆ é™¤ä¸‰ä¸ªè®°å½•ï¼šç”¨æˆ·è®°å½•ã€ç§äººä¿¡æ¯å’Œå¸–å­ã€‚å…³é”®æ˜¯æ‰€æœ‰çš„åˆ é™¤æ“ä½œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œæˆ–è€…æ ¹æœ¬ä¸æˆåŠŸï¼Œè¿™å°±å˜æˆäº†ä¸€ä¸ªäº‹åŠ¡ã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨åƒ`deleteMany`è¿™æ ·çš„å•ä¸€æ‰¹é‡æ“ä½œæ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è·¨ä¸‰ä¸ªæ¨¡å‹è¿›è¡Œåˆ é™¤ã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`$transaction` API æ¥ä¸€èµ·è¿è¡Œä¸‰ä¸ªæ“ä½œ - ä¸¤ä¸ª deleteMany å’Œä¸€ä¸ª delete:

```ts
const id = 9 // éœ€è¦åˆ é™¤çš„user

const deletePosts = prisma.post.deleteMany({
  where: {
    userId: id,
  },
})

const deleteMessages = prisma.privateMessage.deleteMany({
  where: {
    userId: id,
  },
})

const deleteUser = prisma.user.delete({
  where: {
    id: id,
  },
})

await prisma.$transaction([deletePosts, deleteMessages, deleteUser]) // Operations succeed or fail together
```

#### åœºæ™¯: é¢„å…ˆè®¡ç®— ID å’Œ `$transaction` API

`$transaction` API ä¸æ”¯æŒä¾èµ–å†™å…¥ - å¦‚æœæ“ä½œ A ä¾èµ–äºæ“ä½œ B ç”Ÿæˆçš„ IDï¼Œè¯·ä½¿ç”¨[åµŒå¥—å†™æ³•](#nested-writes)ã€‚ç„¶è€Œï¼Œå¦‚æœä½ é¢„å…ˆè®¡ç®—äº† IDï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ç”Ÿæˆ GUIDï¼‰ï¼Œä½ çš„å†™å…¥å°±å˜å¾—ç‹¬ç«‹äº†ã€‚è€ƒè™‘ä¸€ä¸‹åµŒå¥—å†™çš„ä¾‹å­ä¸­çš„æ³¨å†Œæµç¨‹ï¼š

```ts
await prisma.team.create({
  data: {
    name: 'Aurora Adventures',
    members: {
      create: {
        email: 'alice@prisma.io',
      },
    },
  },
})
```

ç›¸åçš„ï¼Œä¸è‡ªåŠ¨ç”Ÿæˆ IDï¼ŒæŠŠ`Team`å’Œ`User`çš„`id`å­—æ®µæ”¹æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆå¦‚æœä½ ä¸æä¾›ä¸€ä¸ªå€¼ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª UUIDï¼‰ã€‚è¿™ä¸ªä¾‹å­ä½¿ç”¨ UUIDs:

```prisma highlight=2,9;delete|3,10;add
model Team {
  id      Int    @id @default(autoincrement())
  id      String @id @default(uuid())
  name    String
  members User[]
}

model User {
  id    Int    @id @default(autoincrement())
  id    String @id @default(uuid())
  email String @unique
  teams Team[]
}
```

é‡æ„æ³¨å†Œæµç¨‹çš„ä¾‹å­ï¼Œä½¿ç”¨`$transaction` API è€Œä¸æ˜¯`åµŒå¥—å†™æ³•`:

```ts
import { v4 } from 'uuid'

const teamID = v4()
const userID = v4()

await prisma.$transaction([
  prisma.user.create({
    data: {
      id: userID,
      email: 'alice@prisma.io',
      team: {
        id: teamID,
      },
    },
  }),
  prisma.team.create({
    data: {
      id: teamID,
      name: 'Aurora Adventures',
    },
  }),
])
```

ä»æŠ€æœ¯ä¸Šè®²ï¼Œå¦‚æœä½ å–œæ¬¢è¿™ç§è¯­æ³•ï¼Œä½ ä»ç„¶å¯ä»¥ä½¿ç”¨å¸¦æœ‰é¢„è®¡ç®— API çš„åµŒå¥—å†™æ³•:

```ts
import { v4 } from 'uuid'

const teamID = v4()
const userID = v4()

await prisma.team.create({
  data: {
    id: teamID,
    name: 'Aurora Adventures',
    members: {
      create: {
        id: userID,
        email: 'alice@prisma.io',
        team: {
          id: teamID,
        },
      },
    },
  },
})
```

å¦‚æœä½ å·²ç»åœ¨ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ ID å’ŒåµŒå¥—å†™æ³•ï¼Œå°±æ²¡å¿…è¦æ”¹ç”¨æ‰‹åŠ¨ç”Ÿæˆçš„ ID å’Œ`$transaction` API äº†ã€‚

## è¯»ã€æ”¹ã€å†™

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ä½œä¸ºåŸå­æ“ä½œçš„ä¸€éƒ¨åˆ† - ä¹Ÿç§°ä¸º[è¯»-ä¿®æ”¹-å†™æ¨¡å¼](https://en.wikipedia.org/wiki/Read%E2%80%93modify%E2%80%93write)ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè¯»-ä¿®æ”¹-å†™æ¨¡å¼çš„ä¾‹å­ï¼š

- ä»æ•°æ®åº“ä¸­è¯»å–ä¸€ä¸ªå€¼
- è¿è¡Œä¸€äº›é€»è¾‘æ¥æ“ä½œè¯¥å€¼ï¼ˆä¾‹å¦‚ï¼Œè”ç³»ä¸€ä¸ªå¤–éƒ¨ API)
- å†™å€¼åˆ°æ•°æ®åº“

æ‰€æœ‰çš„æ“ä½œéƒ½åº”è¯¥**ä¸€èµ·æˆåŠŸæˆ–å¤±è´¥**ï¼Œè€Œä¸ä¼šå¯¹æ•°æ®åº“è¿›è¡Œä¸å¿…è¦çš„æ”¹å˜ï¼Œä½†ä½ ä¸ä¸€å®šéœ€è¦ä½¿ç”¨ä¸€ä¸ªå®é™…çš„æ•°æ®åº“äº‹åŠ¡ã€‚æœ¬æŒ‡å—çš„è¿™ä¸€èŠ‚ä»‹ç»äº†ä½¿ç”¨ Prisma Client å’Œè¯»-æ”¹-å†™æ¨¡å¼çš„ä¸¤ç§å·¥ä½œæ–¹å¼ï¼š

- è®¾è®¡å¹‚ç­‰ API
- ä¼˜åŒ–å¹¶å‘æ§åˆ¶

### å¹‚ç­‰ API

å¹‚ç­‰æ˜¯æŒ‡ç”¨ç›¸åŒçš„å‚æ•°å¤šæ¬¡è¿è¡Œç›¸åŒçš„é€»è¾‘ï¼Œå¹¶å¾—åˆ°ç›¸åŒçš„ç»“æœï¼šæ— è®ºä½ è¿è¡Œä¸€æ¬¡è¿˜æ˜¯ä¸€åƒæ¬¡ï¼Œå¯¹**æ•°æ®åº“çš„å½±å“**éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ¯”å¦‚è¯´ï¼š

- **éå¹‚ç­‰**: åœ¨æ•°æ®åº“ä¸­æ›´æ–°æˆ–æ’å…¥ä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€ä¸º "letoya@prisma.io "çš„ç”¨æˆ·ã€‚ç”¨æˆ·è¡¨å¹¶ä¸å¼ºåˆ¶æ‰§è¡Œå”¯ä¸€çš„ç”µå­é‚®ä»¶åœ°å€ã€‚å¦‚æœä½ è¿è¡Œè¯¥é€»è¾‘ä¸€æ¬¡ï¼ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼‰æˆ–åæ¬¡ï¼ˆåˆ›å»ºåä¸ªç”¨æˆ·ï¼‰ï¼Œå¯¹æ•°æ®åº“çš„å½±å“æ˜¯ä¸åŒçš„ã€‚
- **å¹‚ç­‰**: åœ¨æ•°æ®åº“ä¸­æ›´æ–°æˆ–æ’å…¥ä¸€ä¸ªç”¨æˆ·ï¼Œç”µå­é‚®ä»¶åœ°å€ä¸º "letoya@prisma.io"ã€‚ç”¨æˆ·è¡¨å¼ºåˆ¶è¦æ±‚ç”µå­é‚®ä»¶åœ°å€å”¯ä¸€ã€‚å¦‚æœä½ è¿è¡Œè¯¥é€»è¾‘ä¸€æ¬¡ï¼ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼‰æˆ–åæ¬¡ï¼ˆç°æœ‰ç”¨æˆ·ä»¥ç›¸åŒçš„è¾“å…¥è¢«æ›´æ–°ï¼‰ï¼Œå¯¹æ•°æ®åº“çš„å½±å“æ˜¯ä¸€æ ·çš„ã€‚

å¹‚ç­‰æ˜¯ä½ å¯ä»¥è€Œä¸”åº”è¯¥å°½å¯èƒ½ç§¯æåœ°åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­è®¾è®¡çš„ä¸œè¥¿ã€‚

#### ä½•æ—¶è®¾è®¡å¹‚ç­‰ API

- âœ” ä½ éœ€è¦èƒ½å¤Ÿé‡è¯•ç›¸åŒçš„é€»è¾‘ï¼Œè€Œä¸åœ¨æ•°æ®åº“ä¸­äº§ç”Ÿä¸å¿…è¦çš„å‰¯ä½œç”¨

#### åœºæ™¯: å‡çº§ Slack å›¢é˜Ÿ

ä½ æ­£åœ¨ä¸º Slack åˆ›å»ºä¸€ä¸ªå‡çº§æµç¨‹ï¼Œå…è®¸å›¢é˜Ÿè§£é”ä»˜è´¹åŠŸèƒ½ã€‚å›¢é˜Ÿå¯ä»¥é€‰æ‹©ä¸åŒçš„è®¡åˆ’ï¼ŒæŒ‰ç”¨æˆ·æ¯æœˆä»˜è´¹ã€‚ä½ ä½¿ç”¨ Stripe ä½œä¸ºä½ çš„æ”¯ä»˜ç½‘å…³ï¼Œå¹¶æ‰©å±•ä½ çš„å›¢é˜Ÿæ¨¡å‹ä»¥å­˜å‚¨`stripeCustomerId`ï¼Œå¹¶åœ¨ Stripe ä¸­ç®¡ç†è®¢é˜…ã€‚

```prisma highlight=5;normal
model Team {
  id               Int     @id @default(autoincrement())
  name             String
  User             User[]
  stripeCustomerId String?
}
```

å‡çº§çš„æµç¨‹æ˜¯è¿™æ ·çš„:

1. è®¡ç®—ç”¨æˆ·çš„æ•°é‡
2. åœ¨ Stripe ä¸­åˆ›å»ºä¸€ä¸ªåŒ…æ‹¬ç”¨æˆ·æ•°é‡çš„è®¢é˜…å·
3. å°†å›¢é˜Ÿä¸ Stripe çš„å®¢æˆ· ID è”ç³»èµ·æ¥ï¼Œä»¥è§£é”ä»˜è´¹åŠŸèƒ½

```ts
const teamId = 9
const planId = 'plan_id'

// ç»Ÿè®¡team memberæ•°é‡
const numTeammates = await prisma.user.count({
  where: {
    teams: {
      some: {
        id: teamId,
      },
    },
  },
})

// åœ¨Stripeä¸­ä¸ºplan-9454549åˆ›å»ºä¸€ä¸ªcustomer
const customer = await stripe.customers.create({
  externalId: teamId,
  plan: planId,
  quantity: numTeammates,
})

// ç”¨customer IDæ›´æ–°teamï¼Œè¡¨æ˜ä»–ä»¬æ˜¯ä¸€ä¸ªcustomer
// å¹¶æ”¯æŒä»æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç åœ¨Stripeä¸­æŸ¥è¯¢è¯¥customer
await prisma.team.update({
  data: {
    customerId: customer.id,
  },
  where: {
    id: teamId,
  },
})
```

è¿™ä¸ªä¾‹å­æœ‰ä¸€ä¸ªé—®é¢˜ï¼šä½ åªèƒ½è¿è¡Œä¸€æ¬¡è¿™ä¸ªé€»è¾‘ã€‚è€ƒè™‘ä¸‹é¢çš„æƒ…å†µ:

1. Stripe åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å®¢æˆ·å’Œè®¢é˜…ï¼Œå¹¶è¿”å›ä¸€ä¸ªå®¢æˆ· ID
2. æ›´æ–°å›¢é˜Ÿ**å¤±è´¥** - è¯¥å›¢é˜Ÿåœ¨ Slack æ•°æ®åº“ä¸­æœªè¢«æ ‡è®°ä¸ºå®¢æˆ·
3. å®¢æˆ·è¢« Stripe æ”¶å–è´¹ç”¨ï¼Œä½†ä»˜è´¹åŠŸèƒ½åœ¨ Slack ä¸­æ²¡æœ‰è¢«è§£é”ï¼Œå› ä¸ºè¯¥å›¢é˜Ÿç¼ºä¹æœ‰æ•ˆçš„`customerId`
4. å†æ¬¡è¿è¡Œç›¸åŒçš„ä»£ç ä¹Ÿæ˜¯å¦‚æ­¤:

   - å¯¼è‡´é”™è¯¯æ˜¯å› ä¸ºå›¢é˜Ÿï¼ˆç”± externalId å®šä¹‰ï¼‰å·²ç»å­˜åœ¨ - Stripe ä»æœªè¿”å›ä¸€ä¸ªå®¢æˆ· ID
   - å¦‚æœ externalId ä¸å—å”¯ä¸€çº¦æŸï¼ŒStripe å°±ä¼šåˆ›å»ºå¦ä¸€ä¸ªè®¢é˜…ï¼ˆ**éå¹‚ç­‰**ï¼‰

åœ¨å‡ºç°é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œæ‚¨ä¸èƒ½é‡æ–°è¿è¡Œè¿™æ®µä»£ç ï¼Œè€Œä¸”æ‚¨åªèƒ½ä»˜è´¹ä¸¤æ¬¡æ‰èƒ½æ”¹å˜å…¶ä»–è®¢é˜…è®¡åˆ’ã€‚

ä¸‹é¢çš„é‡æ„ï¼ˆçªå‡ºæ˜¾ç¤ºï¼‰å¼•å…¥äº†ä¸€ä¸ªæœºåˆ¶ï¼Œè¯¥æœºåˆ¶ä¼šæ£€æŸ¥è®¢é˜…æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¹¶åˆ›å»ºæè¿°æˆ–æ›´æ–°ç°æœ‰çš„è®¢é˜…ï¼ˆå¦‚æœè¾“å…¥ç›¸åŒï¼Œå°†ä¿æŒä¸å˜ï¼‰ï¼š

```ts highlight=12-27;normal
// è®¡ç®—ç”¨æˆ·æ•°ä¹˜ä»¥æ¯ä¸ªç”¨æˆ·çš„æˆæœ¬
const numTeammates = await prisma.user.count({
  where: {
    teams: {
      some: {
        id: teamId,
      },
    },
  },
})

// Find customer in Stripe
let customer = await stripe.customers.get({ externalId: teamID })

if (customer) {
  // If team already exists, update
  customer = await stripe.customers.update({
    externalId: teamId,
    plan: 'plan_id',
    quantity: numTeammates,
  })
} else {
  customer = await stripe.customers.create({
    // If team does not exist, create customer
    externalId: teamId,
    plan: 'plan_id',
    quantity: numTeammates,
  })
}

// ç”¨customer IDæ›´æ–°teamï¼Œè¡¨æ˜ä»–ä»¬æ˜¯ä¸€ä¸ªcustomer
// å¹¶æ”¯æŒä»æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç åœ¨Stripeä¸­æŸ¥è¯¢è¯¥customer
await prisma.team.update({
  data: {
    customerId: customer.id,
  },
  where: {
    id: teamId,
  },
})
```

ç°åœ¨ä½ å¯ä»¥ç”¨ç›¸åŒçš„è¾“å…¥å¤šæ¬¡é‡è¯•ç›¸åŒçš„é€»è¾‘ï¼Œè€Œä¸ä¼šäº§ç”Ÿä¸è‰¯å½±å“ã€‚ä¸ºäº†è¿›ä¸€æ­¥åŠ å¼ºè¿™ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥å¼•å…¥ä¸€ä¸ªæœºåˆ¶ï¼Œå¦‚æœæ›´æ–°åœ¨è®¾å®šçš„æ¬¡æ•°åæ²¡æœ‰æˆåŠŸï¼Œè®¢é˜…ä¼šè¢«å–æ¶ˆæˆ–æš‚æ—¶åœç”¨ã€‚

### ä¼˜åŒ–å¹¶å‘æ§åˆ¶

ä¼˜åŒ–å¹¶å‘æ§åˆ¶ï¼ˆOCCï¼‰æ˜¯ä¸€ç§å¤„ç†å•ä¸ªå®ä½“ä¸Šå¹¶å‘æ“ä½œçš„æ¨¡å‹ï¼Œå®ƒä¸ä¾èµ–äº ğŸ”’ é”å®šã€‚ç›¸åï¼Œæˆ‘ä»¬**ä¹è§‚**åœ°å‡è®¾ä¸€æ¡è®°å½•åœ¨è¯»å†™ä¹‹é—´ä¿æŒä¸å˜ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªå¹¶å‘æ ‡è®°ï¼ˆä¸€ä¸ªæ—¶é—´æˆ³æˆ–ç‰ˆæœ¬å­—æ®µï¼‰æ¥æ£€æµ‹è®°å½•çš„å˜åŒ–ã€‚

å¦‚æœå‘ç”Ÿ âŒ å†²çªï¼ˆåœ¨ä½ è¯»å–è®°å½•åï¼Œå…¶ä»–äººæ”¹å˜äº†è¯¥è®°å½•ï¼‰ï¼Œä½ å°±å–æ¶ˆè¯¥äº‹åŠ¡ã€‚æ ¹æ®ä½ çš„æƒ…å†µï¼Œä½ å¯ä»¥ï¼š

- é‡è¯•è¯¥äº‹åŠ¡ï¼ˆé¢„è®¢å¦ä¸€ä¸ªç”µå½±é™¢çš„åº§ä½ï¼‰
- æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼ˆæé†’ç”¨æˆ·ä»–ä»¬å³å°†è¦†ç›–åˆ«äººæ‰€åšçš„æ”¹å˜ï¼‰

æœ¬èŠ‚ä»‹ç»äº†å¦‚ä½•å»ºç«‹ä½ è‡ªå·±çš„ä¹è§‚å¹¶å‘æ§åˆ¶ã€‚ä¹Ÿè¯·å‚è§ï¼š[GitHub ä¸Šçš„åº”ç”¨çº§ä¹è§‚å¹¶å‘æ§åˆ¶](https://github.com/prisma/prisma/issues/4988)çš„è®¡åˆ’

#### ä½•æ—¶ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶

- âœ” é¢„è®¡ä¼šæœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚ï¼ˆå¤šäººé¢„è®¢ç”µå½±é™¢åº§ä½ï¼‰
- âœ” é¢„è®¡è¿™äº›å¹¶å‘è¯·æ±‚ä¹‹é—´çš„å†²çªå°†æ˜¯ç½•è§çš„

åœ¨æœ‰å¤§é‡å¹¶å‘è¯·æ±‚çš„åº”ç”¨ç¨‹åºä¸­é¿å…åŠ é”ï¼Œå¯ä»¥ä½¿åº”ç”¨ç¨‹åºå¯¹è´Ÿè½½çš„é€‚åº”æ€§æ›´å¼ºï¼Œæ€»ä½“ä¸Šæ›´å…·æœ‰å¯æ‰©å±•æ€§ã€‚å°½ç®¡é”æœ¬èº«å¹¶ä¸æ˜¯åäº‹ï¼Œä½†åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„é”å¯èƒ½ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„åæœ - å³ä½¿ä½ åªæ˜¯é”å®šä¸ªåˆ«è¡Œï¼Œè€Œä¸”åªæ˜¯é”å®šå¾ˆçŸ­çš„æ—¶é—´ã€‚æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ï¼š

- [ä¸ºä»€ä¹ˆ ROLLOCK æç¤ºä¼šä½¿ SQL Server ä¸­çš„æŸ¥è¯¢å˜æ…¢ï¼Œé˜»å¡å˜ä¸¥é‡ï¼Ÿ](https://littlekendra.com/2016/02/04/why-rowlock-hints-can-make-queries-slower-and-blocking-worse-in-sql-server/)
- [é«˜å¹¶å‘ç­–ç•¥](https://www.ibm.com/developerworks/library/j-ts5/index.html)

#### åœºæ™¯: åœ¨ç”µå½±é™¢é¢„è®¢åº§ä½

ä½ æ­£åœ¨ä¸ºä¸€å®¶ç”µå½±é™¢å¼€å‘ä¸€ä¸ªé¢„è®¢ç³»ç»Ÿã€‚æ¯éƒ¨ç”µå½±éƒ½æœ‰ä¸€å®šæ•°é‡çš„åº§ä½ã€‚ä¸‹é¢çš„æ¨¡å¼æ˜¯ç”µå½±å’Œåº§ä½çš„æ¨¡å‹ï¼š

```ts
model Seat {
  id        Int   @id @default(autoincrement())
  userId    Int?
  claimedBy User? @relation(fields: [userId], references: [id])
  movieId   Int
  movie     Movie @relation(fields: [movieId], references: [id])
}

model Movie {
  id    Int    @id     @default(autoincrement())
  name  String @unique
  seats Seat[]
}
```

ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„åº§ä½å¹¶å°†è¯¥åº§ä½åˆ†é…ç»™ä¸€ä¸ªç”¨æˆ·:

```ts
const movieName = 'Hidden Figures'

// æ‰¾åˆ°é¦–ä¸ªå¯ç”¨åº§ä½
const availableSeat = await prisma.seat.findFirst({
  where: {
    movie: {
      name: movieName,
    },
    claimedBy: null,
  },
})

// å¦‚æœåº§ä½ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸
if (!availableSeat) {
  throw new Error(`Oh no! ${movieName} is all booked.`)
}

// è®¤é¢†åº§ä½
await prisma.seat.update({
  data: {
    claimedBy: userId,
  },
  where: {
    id: availableSeat.id,
  },
})
```

ç„¶è€Œï¼Œè¿™ä¸ªä»£ç å­˜åœ¨ "é‡å¤é¢„è®¢é—®é¢˜â€- ä¸¤ä¸ªäººæœ‰å¯èƒ½é¢„è®¢ç›¸åŒçš„åº§ä½:

1. åº§ä½ 3A è¿”å›ç»™ Sorcha (`findFirst`)
2. åº§ä½ 3A è¿”è¿˜ç»™ Ellen (`findFirst`)
3. åº§ä½ 3A ç”± Sorcha è®¤é¢† (`update`)
4. åº§ä½ 3A ç”± Ellen è®¤é¢†ï¼ˆ`update` - è¦†ç›– Sorcha çš„è®¤é¢†ï¼‰

å°½ç®¡ Sorcha å·²ç»æˆåŠŸé¢„è®¢äº†åº§ä½ï¼Œä½†ç³»ç»Ÿæœ€ç»ˆè¿˜æ˜¯å­˜å‚¨äº† Ellen çš„è¯·æ±‚ã€‚ä¸ºäº†ç”¨ä¹è§‚çš„å¹¶å‘æ§åˆ¶è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç»™åº§ä½æ·»åŠ ä¸€ä¸ª`version`å­—æ®µ:

```prisma highlight=7;normal
model Seat {
  id        Int   @id @default(autoincrement())
  userId    Int?
  claimedBy User? @relation(fields: [userId], references: [id])
  movieId   Int
  movie     Movie @relation(fields: [movieId], references: [id])
  version   Int
}
```

Next, adjust the code to check the `version` field before updating:

```ts highlight=18-37;normal
const userEmail = 'alice@prisma.io'
const movieName = 'Hidden Figures'

// æ‰¾åˆ°é¦–ä¸ªå¯ç”¨åº§ä½
// availableSeat.version å¯èƒ½ä¸º 0
const availableSeat = await client.seat.findFirst({
  where: {
    Movie: {
      name: movieName,
    },
    claimedBy: null,
  },
})

if (!availableSeat) {
  throw new Error(`Oh no! ${movieName} is all booked.`)
}

// åªæœ‰å½“availableSeat.versionä¸æˆ‘ä»¬è¦æ›´æ–°çš„ç‰ˆæœ¬ç›¸åŒ¹é…æ—¶ï¼Œæ‰ä¼šå°†è¯¥åº§ä½æ ‡è®°ä¸ºå·²ç”³è¯·ã€‚
// æ­¤å¤–ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œè¿™ä¸ªæ›´æ–°æ—¶ï¼Œversionä¼šé€’å¢ï¼Œ
// è¿™æ ·æ‰€æœ‰å…¶ä»–è¯•å›¾é¢„è®¢åŒä¸€åº§ä½çš„å®¢æˆ·å°†æœ‰ä¸€ä¸ªè¿‡æ—¶çš„ç‰ˆæœ¬ã€‚
const seats = await client.seat.updateMany({
  data: {
    claimedBy: userEmail,
    version: {
      increment: 1,
    },
  },
  where: {
    id: availableSeat.id,
    version: availableSeat.version, // è¿™ä¸ªversionå­—æ®µæ˜¯å…³é”®ï¼›åªæœ‰å½“å†…å­˜ä¸­çš„ç‰ˆæœ¬ä¸æ•°æ®åº“çš„ç‰ˆæœ¬ç›¸åŒ¹é…æ—¶ï¼Œæ‰ä¼šè®¤é¢†åº§ä½ï¼Œå®ƒè¡¨æ˜è¯¥å­—æ®µæ²¡æœ‰è¢«æ›´æ–°ã€‚
  },
})

if (seats.count === 0) {
  throw new Error(`That seat is already booked! Please try again.`)
}
```

ç°åœ¨ä¸å¯èƒ½æœ‰ä¸¤ä¸ªäººé¢„è®¢åŒä¸€ä¸ªåº§ä½:

1. åº§ä½ 3A å½’å± Sorcha(`version` is 0)
2. åº§ä½ 3A è¿”è¿˜ç»™ Ellen (`version` is 0)
3. åº§ä½ 3A ç”± Sorcha è®¤é¢†(`version`é€’å¢ä¸º 1ï¼Œé¢„è®¢æˆåŠŸ)
4. åº§ä½ 3A ç”± Ellen è®¤é¢† (å†…å­˜`version` (0) ä¸æ•°æ®åº“`version` (1) ä¸åŒ¹é… - é¢„è®¢ä¸æˆåŠŸ)

### äº¤äº’å¼äº‹åŠ¡ï¼ˆé¢„è§ˆç‰ˆ)

å¦‚æœä½ æœ‰ä¸€ä¸ªç°æœ‰çš„åº”ç”¨ç¨‹åºï¼Œé‡æ„ä½ çš„åº”ç”¨ç¨‹åºä»¥ä½¿ç”¨ä¹è§‚çš„å¹¶å‘æ§åˆ¶å¯èƒ½æ˜¯ä¸€é¡¹é‡è¦çš„å·¥ä½œã€‚äº¤äº’å¼äº‹åŠ¡ä¸ºè¿™æ ·çš„æƒ…å†µæä¾›äº†ä¸€ä¸ªæœ‰ç”¨çš„é¿é£æ¸¯ã€‚

ä¸ºäº†æ”¯æŒè¿™ç§ç”¨ä¾‹å’Œæ›´å¤šçš„ç”¨ä¾‹ï¼Œä½ å¯ä»¥é€šè¿‡åœ¨ä½ çš„ Prisma Schema çš„ç”Ÿæˆå™¨ä¸­æ·»åŠ `interactiveTransactions`æ¥å¯ç”¨äº¤äº’å¼äº‹åŠ¡:

```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["interactiveTransactions"]
}
```

ç„¶åä½ å¯ä»¥æŠŠä¸€ä¸ªå¼‚æ­¥å‡½æ•°ä¼ å…¥[$transaction](https://www.prisma.io/docs/guides/performance-and-optimization/prisma-client-transactions-guide/#transaction-api).

ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨çº¿è´­ä¹°ç”µå½±ç¥¨çš„ä¾‹å­ã€‚è¿™æ˜¯ä¸€ä¸ªäº¤äº’å¼äº¤æ˜“çš„å¥½ç”¨ä¾‹ï¼Œå› ä¸ºä½ ä¸æƒ³æŠŠåŒä¸€å¼ ç¥¨å–ä¸¤æ¬¡ï¼š

```ts highlight=6,8,25;normal
import { Seat } from 'prisma'
const userEmail = 'alice@prisma.io'
const movieName = 'HiddenFigures'

// å¼€å§‹äº‹åŠ¡
const seat: Seat = await prisma.$transaction(async (prisma) => {
  // æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨åº§ä½
  const availableSeat = await prisma.seat.findFirst({
    where: {
      claimedBy: null,
      movie: {
        name: movieName,
      },
    },
  })

  // å¦‚æœåº§ä½ä¸å­˜åœ¨æŠ›å¼‚å¸¸
  if (!availableSeat) {
    // è¿™å°†ä¼šæ»šäº‹åŠ¡
    throw new Error(`Oh no! ${movieName} is all booked.`)
  }

  // è®¤é¢†åº§ä½ï¼Œæäº¤äº‹åŠ¡ï¼Œè¿”å›ç»“æœ
  return prisma.seat.update({
    data: {
      claimedBy: userEmail,
    },
    where: {
      id: availableSeat.id,
    },
  })
})
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`findFirst`å’Œ`update`éƒ½åœ¨ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­è¿è¡Œã€‚å½“ä½ çš„åº”ç”¨ç¨‹åºåˆ°è¾¾å‡½æ•°çš„æœ«å°¾æ—¶ï¼Œäº‹åŠ¡è¢«æäº¤åˆ°æ•°æ®åº“ä¸­ã€‚

å¦‚æœä½ çš„åº”ç”¨ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œå¼‚æ­¥å‡½æ•°å°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸å¹¶è‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚ä¸ºäº†æ•æ‰è¿™ä¸ªå¼‚å¸¸ï¼Œä½ å¯ä»¥æŠŠ`$transaction`åŒ…åœ¨ä¸€ä¸ª try-catch å—ä¸­ã€‚

<Admonition type="warning">

**éœ€è°¨æ…åœ°ä½¿ç”¨äº¤äº’å¼äº‹åŠ¡**. è°¨æ…åœ°ä½¿ç”¨äº¤äº’å¼äº‹åŠ¡ã€‚é•¿æ—¶é—´ä¿æŒäº‹åŠ¡å¼€æ”¾ä¼šæŸå®³æ•°æ®åº“æ€§èƒ½ï¼Œç”šè‡³ä¼šå¯¼è‡´æ­»é”ã€‚å°½é‡é¿å…åœ¨ä½ çš„äº‹åŠ¡å‡½æ•°ä¸­æ‰§è¡Œç½‘ç»œè¯·æ±‚å’Œæ‰§è¡Œç¼“æ…¢çš„æŸ¥è¯¢ã€‚æˆ‘ä»¬å»ºè®®ä½ å°½å¯èƒ½å¿«åœ°è¿›å…¥å’Œé€€å‡º!

</Admonition>

## æ€»ç»“

Prisma æ”¯æŒå¤šç§å¤„ç†äº‹åŠ¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ APIï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ”¯æŒåœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­å¼•å…¥ä¹è§‚çš„å¹¶å‘æ§åˆ¶å’Œå¹‚ç­‰çš„èƒ½åŠ›ã€‚å¦‚æœä½ è§‰å¾—ä½ çš„åº”ç”¨ç¨‹åºä¸­çš„ç”¨ä¾‹æ²¡æœ‰è¢«ä»»ä½•å»ºè®®çš„é€‰é¡¹æ‰€è¦†ç›–ï¼Œè¯·åœ¨ GitHub ä¸Šå¼€ä¸€ä¸ª[GitHub issue](https://github.com/prisma/prisma/issues/new/choose) æ¥å¼€å§‹è®¨è®ºã€‚

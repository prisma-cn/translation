---
title: 'éƒ¨ç½²åˆ°Azure Functions'
metaTitle: 'å¦‚ä½•ç”¨Azure SQLå°†REST APIéƒ¨ç½²åˆ°Azure Functionsä¸Š'
metaDescription: 'äº†è§£å¦‚ä½•å°†åŸºäºPrismaçš„REST APIéƒ¨ç½²åˆ°Azure Functionså¹¶è¿æ¥åˆ°Azure SQLæ•°æ®åº“ã€‚'
---

<TopBlock>

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œä½ å°†è®¾ç½®å’Œéƒ¨ç½²ä¸€ä¸ªåŸºäº Prisma çš„ Node.js REST API åˆ°[Azure Functions](https://azure.microsoft.com/en-us/services/functions/)ï¼Œå¹¶å°†[Azure SQL](https://azure.microsoft.com/en-us/services/sql-database/)ä½œä¸ºæ•°æ®åº“ã€‚è¯¥åº”ç”¨ç¨‹åºå°†æš´éœ²ä¸€ä¸ª REST APIï¼Œå¹¶ä½¿ç”¨ Prisma å®¢æˆ·ç«¯æ¥å¤„ç†ä»æ•°æ®åº“ä¸­è·å–ã€åˆ›å»ºå’Œåˆ é™¤è®°å½•ã€‚

Azure Functions æ˜¯ä¸€ä¸ª serverless éƒ¨ç½²å¹³å°ï¼Œå…è®¸ä½ éƒ¨ç½²ä»£ç è€Œæ— éœ€ç»´æŠ¤åŸºç¡€è®¾æ–½ã€‚Azure SQL æ•°æ®åº“æ˜¯ä¸€ä¸ªä¸ºäº‘è®¡ç®—å»ºç«‹çš„å…³ç³»å‹æ•°æ®åº“æœåŠ¡ï¼Œå…·æœ‰è‡ªåŠ¨æ‰©å±•åŠŸèƒ½ã€‚

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œä½ å°†åœ¨ Azure ä¸­åˆ›å»ºå¿…è¦çš„èµ„æºï¼Œä½¿ç”¨ Prisma Migrate åˆ›å»ºæ•°æ®åº“æ¨¡å¼ï¼Œå¹¶éƒ¨ç½²ä¸€ä¸ªå¸¦æœ‰èµ„æºç«¯ç‚¹çš„ Node.js REST APIï¼Œä½¿ç”¨ Prisma Client æ¥å¤„ç†é’ˆå¯¹ Azure SQL æ•°æ®åº“çš„æ•°æ®åº“æ“ä½œã€‚

æœ¬æŒ‡å—çš„é‡ç‚¹æ˜¯å±•ç¤ºå¦‚ä½•åœ¨ Azure äº‘ä¸­ä½¿ç”¨ Prismaï¼Œé‡ç‚¹æ˜¯ Azure Functions å’Œ Azure SQLã€‚å‡ºå‘ç‚¹æ˜¯[Prisma Azure Functions èŒƒä¾‹](https://github.com/prisma/prisma-examples/tree/latest/deployment-platforms/azure-functions) - ä¸€ä¸ªç®€å•åšå®¢çš„ REST APIï¼Œæœ‰ä¸¤ä¸ªæ¨¡å‹ã€‚`ç”¨æˆ·'å’Œ`å¸–å­'ï¼ˆ_1:n_ï¼‰ã€‚è¿™ä¸ªä¾‹å­åŒ…å«é¢„è®¾ä¸ºæ— æœåŠ¡å™¨å‡½æ•°çš„ REST ç«¯ç‚¹ã€‚

è¯·æ³¨æ„ï¼ŒPrisma ä¸­çš„ Azure SQL æ”¯æŒå¤„äº[é¢„è§ˆé˜¶æ®µ](/about/releases#preview)ã€‚

é€šè¿‡ Azure Functionsï¼ŒåŸºæœ¬æ„å»ºæ¨¡å—æ˜¯[**åŠŸèƒ½åº”ç”¨**](https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference#function-app)ã€‚ä¸€ä¸ªå‡½æ•°åº”ç”¨åœ¨ Azure ä¸­æä¾›äº†ä¸€ä¸ªæ‰§è¡Œç¯å¢ƒï¼Œä½ çš„å‡½æ•°åœ¨å…¶ä¸­è¿è¡Œã€‚å®ƒæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå•ç‹¬çš„å‡½æ•°ç»„æˆçš„ï¼Œè¿™äº›å‡½æ•°è¢«ä¸€èµ·ç®¡ç†ã€éƒ¨ç½²å’Œæ‰©å±•ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥æŠŠå¤šä¸ªåŠŸèƒ½ä½œä¸ºä¸€ä¸ªé€»è¾‘å•å…ƒæ¥ç»„ç»‡å’Œé›†ä½“ç®¡ç†ã€‚

> åœ¨æ•´ä¸ªæŒ‡å—ä¸­ï¼Œä½ ä¼šå‘ç°å„ç§**æ£€æŸ¥ç‚¹**ï¼Œä½¿ä½ èƒ½å¤ŸéªŒè¯ä½ æ˜¯å¦æ­£ç¡®æ‰§è¡Œäº†è¿™äº›æ­¥éª¤ã€‚

</TopBlock>

## å‰ææ¡ä»¶

- Azure è´¦å·
- Git å·²å®‰è£…
- [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli) å·²å®‰è£…
- [Node.js](https://nodejs.org/) å·²å®‰è£…

## Prisma å·¥ä½œæµ

Prisma çš„æ ¸å¿ƒæ˜¯[Prisma schema](/concepts/components/prisma-schema) - ä¸€ä¸ªå£°æ˜æ€§çš„é…ç½®ï¼Œä½ åœ¨è¿™é‡Œå®šä¹‰ä½ çš„æ•°æ®æ¨¡å‹å’Œå…¶ä»–ä¸ Prisma æœ‰å…³çš„é…ç½®ã€‚Prisma æ¨¡å¼ä¹Ÿæ˜¯ Prisma å®¢æˆ·ç«¯å’Œ Prisma è¿ç§»çš„å•ä¸€çœŸç†æ¥æºã€‚

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œä½ å°†ä½¿ç”¨[Prisma Migrate]ï¼ˆ/concepts/components/prisma-migrateï¼‰æ¥åˆ›å»ºæ•°æ®åº“æ¨¡å¼ã€‚Prisma Migrate ä»¥ Prisma æ¨¡å¼ä¸ºåŸºç¡€ï¼Œé€šè¿‡ç”Ÿæˆ`.sql`è¿ç§»æ–‡ä»¶æ¥å·¥ä½œï¼Œå¹¶é’ˆå¯¹æ•°æ®åº“æ‰§è¡Œã€‚

Migrate æœ‰ä¸¤ä¸ªä¸»è¦å·¥ä½œæµç¨‹:

- åœ¨æœ¬åœ°å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨`prisma migrate dev`åˆ›å»ºè¿ç§»æ–‡ä»¶å¹¶åº”ç”¨ã€‚
- ä½¿ç”¨`prisma migrate deploy`å°†ç”Ÿæˆçš„è¿ç§»åº”ç”¨åˆ°ç”Ÿäº§ä¸­ã€‚

ä¸ºäº†ç®€æ´èµ·è§ï¼Œæœ¬æŒ‡å—ä¸æ¶‰åŠå¦‚ä½•ä½¿ç”¨`prisma migrate dev`åˆ›å»ºè¿ç§»ã€‚ç›¸åï¼Œå®ƒä¾§é‡äºä½¿ç”¨`prisma migrate deploy`çš„ç”Ÿäº§å·¥ä½œæµç¨‹ï¼Œå¹¶ä½¿ç”¨ç¤ºä¾‹ä»£ç ä¸­çš„ Prisma æ¨¡å¼å’Œ SQL è¿ç§»ã€‚

è¦äº†è§£æ›´å¤šå…³äºå¦‚ä½•ä½¿ç”¨ Prisma Migrate åˆ›å»ºè¿ç§»ï¼Œè¯·æŸ¥çœ‹[ä»å¤´å¼€å§‹æŒ‡å—](/getting-started/setup-prisma/start-from-scratch/relational-databases-typescript-postgres)

## éœ€è¦çš„ Azure èµ„æº

- Resource group
- Azure SQL Database server
- Database
- Firewall rule
- Storage account
- Function App

## 1. ä¸‹è½½æ¡ˆä¾‹ä»£ç å¹¶å®‰è£…ä¾èµ–

æ‰“å¼€ä½ çš„ç»ˆç«¯ï¼Œå¯¼èˆªåˆ°ä½ é€‰æ‹©çš„ä½ç½®ã€‚

åˆ›å»ºåº”ç”¨ç¨‹åºä»£ç çš„ç›®å½•ï¼Œå¹¶ä¸‹è½½ç¤ºä¾‹ä»£ç :

```terminal copy
mkdir prisma-azure
cd prisma-azure
curl https://codeload.github.com/prisma/prisma-examples/tar.gz/latest | tar -xz --strip=3 prisma-examples-latest/deployment-platforms/azure-functions/
```

<!-- tar strip folder is a concatenation of the {REPOSITORY}-{BRANCH}/REF, e.g. prisma-examples-latest -->

**æ£€æŸ¥ç‚¹:** è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ—å‡ºæ–‡ä»¶å¤¹çš„å†…å®¹:

```terminal copy
ls -1
```

ä½ å°†çœ‹åˆ°å¦‚ä¸‹æ–‡ä»¶

```no-lines
CreatePost/
CreateUser/
DeletePost/
FilterPosts/
GetFeed/
GetPost/
PublishPost/
host.json
lib/
node_modules/
package.json
prisma/
proxies.json
```

å®‰è£…ä¾èµ–:

```terminal copy
npm install
```

## 2. ä½¿ç”¨ Azure CLI ç™»å½•åˆ° Azure

é¦–å…ˆåœ¨ä½ çš„ç»ˆç«¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç™»å½•ï¼š

```terminal copy
az login
```

## 3. åœ¨ Azure åˆ›å»º Resource Group

åœ¨ Azure ä¸­ï¼Œresource group æ˜¯ä¸€ç§å°†ä¸åŒçš„äº‘èµ„æºç»„åˆåœ¨ä¸€èµ·çš„æ–¹å¼ã€‚æ¯å½“ä½ åˆ›å»ºä¸€ä¸ªèµ„æºï¼Œä¾‹å¦‚ Azure å‡½æ•°ï¼Œä½ éœ€è¦ç»™å®ƒåˆ†é…ä¸€ä¸ª resource groupã€‚

ç”±äº REST API å°†åŒæ—¶ä½¿ç”¨ Azure å‡½æ•°å’Œ Azure SQL æ•°æ®åº“ï¼Œä½ å°†é¦–å…ˆç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»º resource group:

```terminal copy
az group create --location germanywestcentral --name prisma-azure-example
```

> **Note:** ä¸Šé¢çš„å‘½ä»¤åœ¨`germanywestcentral`åŒºåŸŸåˆ›å»º resource groupã€‚ä½ åº”è¯¥åœ¨ç¦»ä½ çš„ç”¨æˆ·æœ€è¿‘çš„åœ°åŒºåˆ›å»º resource groupã€‚å…³äº Azure åœ°åŒºçš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·è¿è¡Œ`az account list-locations`å‘½ä»¤ã€‚

> **æ£€æŸ¥ç‚¹:** è¯¥å‘½ä»¤åº”è¾“å‡ºæ‰€åˆ›å»ºçš„ resource group çš„ä¿¡æ¯:

```json
{
  "id": "/subscriptions/SUBSCRIPTION_ID/resourceGroups/prisma-azure-example",
  "location": "germanywestcentral",
  "managedBy": null,
  "name": "prisma-azure-example",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}
```

## 4. åˆ›å»º Azure SQL æ•°æ®åº“æœåŠ¡

ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»º Azure SQL æ•°æ®åº“æœåŠ¡:

```terminal copy
az sql server create -l germanywestcentral -g prisma-azure-example --name UNIQUE_DB_SERVER_NAME --admin-user prisma --admin-password CHOOSE_A_PASSWORD --enable-public-network true
```

åœ¨è¿è¡Œè¯¥å‘½ä»¤ä¹‹å‰ï¼Œç”¨`UNIQUE_DB_SERVER_NAME`ä»£æ›¿æ•°æ®åº“çš„å”¯ä¸€åç§°ï¼Œ`åœ¨CHOOSE_A_PASSWORDä¸­è®¾ç½®ä¸€ä¸ªå¯†ç `ï¼Œå¹¶è®°ä¸‹å®ƒ:

è¯¥å‘½ä»¤åšäº†ä»¥ä¸‹å·¥ä½œ:

- åœ¨`germanywestcentral`åœ°åŒºåˆ›å»ºæ•°æ®åº“æœåŠ¡å™¨ã€‚
- å°†å…¶ä¸ä¸Šä¸€æ­¥åˆ›å»ºçš„`prisma-azure-example` resource group å…³è”
- ç”¨`UNIQUE_DB_SERVER_NAME`ä¸º Azure SQL æœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„åå­—
- å°†ç®¡ç†ç”¨æˆ·è®¾ç½®ä¸º prisma
- è®¾ç½®ç®¡ç†å‘˜å¯†ç 
- å¯ç”¨å…¬å…±ç½‘ç»œè®¿é—®ï¼Œè¿™æ ·ä½ å°±å¯ä»¥ä»ä½ çš„æœºå™¨ä¸Šåˆ›å»ºæ•°æ®åº“æ¨¡å¼ã€‚

åœ¨ä¸‹ä¸€æ­¥ï¼Œä½ å°†åˆ›å»º Prisma å°†åœ¨ REST API ä¸­ä½¿ç”¨çš„æ•°æ®åº“ã€‚

## 5. åˆ›å»ºæ•°æ®åº“

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å°†åœ¨ä¸Šä¸€æ­¥åˆ›å»ºçš„æœåŠ¡å™¨ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ã€‚

åœ¨ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†`UNIQUE_DB_SERVER_NAME`æ›¿æ¢ä¸ºä½ åœ¨ä¸Šä¸€æ­¥é€‰æ‹©çš„æ•°æ®åº“åç§°:

```terminal copy
az sql db create --resource-group prisma-azure-example --server UNIQUE_DB_SERVER_NAME --name prisma-azure-example --service-objective Basic
```

ä¸‹é¢æ˜¯è¯¥å‘½ä»¤çš„å‚æ•°æ˜ç»†:

- `--resource-group` å°†æ•°æ®åº“æ·»åŠ åˆ°æ­¥éª¤ 3 ä¸­åˆ›å»ºçš„èµ„æºç»„ä¸­
- `--server` è®¾ç½® Azure SQL æ•°æ®åº“æœåŠ¡å™¨æ¥åˆ›å»ºå®ƒ
- `--name` è®¾ç½®æ•°æ®åº“çš„åç§°
- `--service-objective` è®¾ç½®æ•°æ®åº“çš„æœåŠ¡ç­‰çº§ï¼Œ[å†³å®šäº†æˆæœ¬](https://azure.microsoft.com/en-us/pricing/details/sql-database/single/).

## 6. åˆ›å»ºä¸€ä¸ªé˜²ç«å¢™è§„åˆ™ï¼Œå…è®¸æœ¬åœ°è®¿é—®æ•°æ®åº“

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å°†æ·»åŠ ä¸¤ä¸ªé˜²ç«å¢™è§„åˆ™:

- å…è®¸ä»ä½ æœ¬åœ°è®¡ç®—æœºçš„å…¬å…± IP è¿œç¨‹è®¿é—® Azure SQL æ•°æ®åº“ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨æœ¬åœ°åˆ›å»ºæ•°æ®åº“æ¨¡å¼å¹¶ä½¿ç”¨è¯¥æ•°æ®åº“è¿›è¡Œæµ‹è¯•ã€‚
- å…è®¸ä» Azure Functions è®¿é—® Azure SQL æ•°æ®åº“

### å…è®¸ä»ä½ çš„æœ¬åœ°è®¡ç®—æœºè®¿é—®

é¦–å…ˆç”¨ä»¥ä¸‹å‘½ä»¤ç¡®å®šä½ çš„å…¬å…± IP:

```terminal copy
curl ifconfig.me
```

ä»è¾“å‡ºä¸­å¤åˆ¶ IP å¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”¨ IP åœ°å€æ›¿æ¢`YOUR_PUBLIC_IP`ï¼Œç”¨æ­¥éª¤ 4 ä¸­çš„åç§°æ›¿æ¢`UNIQUE_DB_SERVER_NAME`:

```terminal copy
az sql server firewall-rule create --resource-group prisma-azure-example --server UNIQUE_DB_SERVER_NAME --name allow-local-acccess --start-ip-address YOUR_PUBLIC_IP --end-ip-address YOUR_PUBLIC_IP
```

> **æ£€æŸ¥ç‚¹:** åˆ›å»ºé˜²ç«å¢™è§„åˆ™åï¼Œè¯¥å‘½ä»¤åº”è¾“å‡ºä»¥ä¸‹å†…å®¹:

```json
{
  "endIpAddress": "YOUR_PUBLIC_IP",
  "id": "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/prisma-azure-example/providers/Microsoft.Sql/servers/prisma-db/firewallRules/allow-local-acccess",
  "kind": "v12.0",
  "location": "Germany West Central",
  "name": "allow-local-acccess",
  "resourceGroup": "prisma-azure-example",
  "startIpAddress": "YOUR_PUBLIC_IP",
  "type": "Microsoft.Sql/servers/firewallRules"
}
```

### å…è®¸ä» AzureAzure Functions è®¿é—®

è¦å…è®¸åœ¨ Azure å†…éƒ¨æ‰˜ç®¡çš„åº”ç”¨ç¨‹åºè¿æ¥åˆ°ä½ çš„ SQL æœåŠ¡å™¨ï¼Œå¿…é¡»å¯ç”¨ Azure è¿æ¥ã€‚è¦å¯ç”¨ Azure è¿æ¥ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªé˜²ç«å¢™è§„åˆ™ï¼Œå…¶èµ·å§‹å’Œç»“æŸ IP åœ°å€è®¾ç½®ä¸º 0.0.0.0ã€‚

ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºè¯¥è§„åˆ™:

```terminal copy
az sql server firewall-rule create --resource-group prisma-azure-example --server UNIQUE_DB_SERVER_NAME --name allow-function-acccess --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0
```

## 7. åˆ›å»ºä¸€ä¸ªå­˜å‚¨è´¦æˆ·

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å°†åˆ›å»ºä¸€ä¸ªå­˜å‚¨è´¦æˆ·ï¼Œç”¨æ¥ç»´æŠ¤ä½ çš„åŠŸèƒ½çš„çŠ¶æ€å’Œå…¶ä»–ä¿¡æ¯ã€‚

è¿è¡Œä¸‹é¢çš„å‘½ä»¤æ¥åˆ›å»ºå­˜å‚¨è´¦æˆ·ï¼Œç”¨å­˜å‚¨è´¦æˆ·çš„åå­—æ›¿æ¢`UNIQUE_STORAGE_ACCOUNT_NAME`:

```terminal copy
az storage account create --name UNIQUE_STORAGE_ACCOUNT_NAME --location germanywestcentral --resource-group prisma-azure-example --sku Standard_LRS
```

> **æ£€æŸ¥ç‚¹:** å¦‚æœå‘½ä»¤æˆåŠŸï¼Œå®ƒå°†è¾“å‡ºä¸€ä¸ªå¤§çš„ json å¯¹è±¡ã€‚éªŒè¯`provisioningState`æ˜¯å¦ä¸º`Succeeded`:

```json
{
  "id": "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/prisma-azure-example/providers/Microsoft.Storage/storageAccounts/UNIQUE_STORAGE_ACCOUNT_NAME",
  "provisioningState": "Succeeded",
  "resourceGroup": "prisma-azure-example",
  "type": "Microsoft.Storage/storageAccounts"
}
```

## 8. åˆ›å»ºå‡½æ•°åº”ç”¨ç¨‹åº

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å°†åˆ›å»ºå‡½æ•°åº”ç”¨ç¨‹åºï¼Œå®ƒä¸ºæ‰§è¡Œä½ çš„å‡½æ•°ä»£ç æä¾›ç¯å¢ƒã€‚ä¸€ä¸ªå‡½æ•°åº”ç”¨æ˜ å°„åˆ°ä½ çš„æœ¬åœ°å‡½æ•°é¡¹ç›®ï¼Œè®©ä½ æŠŠå‡½æ•°ä½œä¸ºä¸€ä¸ªé€»è¾‘å•å…ƒåˆ†ç»„ï¼Œä»¥ä¾¿æ›´å®¹æ˜“ç®¡ç†ã€éƒ¨ç½²å’Œå…±äº«èµ„æºã€‚

å¤åˆ¶ä¸‹é¢çš„å‘½ä»¤ï¼Œå°†`FUNCTION_APP_NAME`æ›¿æ¢ä¸ºä½ çš„å‡½æ•°åº”ç”¨ç¨‹åºçš„å”¯ä¸€åç§°ï¼Œå°†`STORAGE_ACCOUNT_NAME`æ›¿æ¢ä¸ºä½ åœ¨ä¸Šä¸€æ­¥é€‰æ‹©çš„åç§°:

```terminal copy
az functionapp create --resource-group prisma-azure-example --consumption-plan-location germanywestcentral --runtime node --runtime-version 14 --functions-version 3 --name FUNCTION_APP_NAME --storage-account STORAGE_ACCOUNT_NAME --os-type Linux
```

> **Note:** åŠŸèƒ½åº”ç”¨çš„åç§°å¿…é¡»æ˜¯å…¨çƒå”¯ä¸€çš„ï¼Œå› ä¸ºå®ƒå°†å†³å®šéƒ¨ç½²åŠŸèƒ½çš„å­åŸŸã€‚

> **æ£€æŸ¥ç‚¹:** å¦‚æœå‘½ä»¤æˆåŠŸï¼Œä½ ä¼šåœ¨ç»ˆç«¯çœ‹åˆ°ä¸€ä¸ªå¤§çš„ JSON å¯¹è±¡ã€‚éªŒè¯è¯¥å¯¹è±¡ä¸­çš„`çŠ¶æ€`æ˜¯å¦è¢«è®¾ç½®ä¸º`è¿è¡Œ`ã€‚

## 9. åœ¨æœ¬åœ°è®¾ç½® DATABASE_URL ç¯å¢ƒå˜é‡

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å°†åœ¨æœ¬åœ°å®šä¹‰`DATABASE_URL`ç¯å¢ƒå˜é‡ï¼Œä»¥åˆ›å»ºæ•°æ®åº“æ¨¡å¼å¹¶åœ¨æœ¬åœ°æµ‹è¯•åŠŸèƒ½ã€‚

è¦æ„å»º connection URLï¼Œè¯·å¤åˆ¶ä»¥ä¸‹ connection URL æ¨¡æ¿ï¼š

```no-lines
sqlserver://DB_SERVER_NAME.database.windows.net:1433;database=DB_NAME;user=DB_ADMIN_USER@DB_SERVER_NAME;password={DB_ADMIN_PASSWORD};encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30
```

æ›¿æ¢ä»¥ä¸‹éƒ¨åˆ†:

- `DB_SERVER_NAME` æ›¿æ¢ä¸ºæ­¥éª¤ 4 ä¸­å®šä¹‰çš„æ•°æ®åº“æœåŠ¡å™¨åç§°
- `DB_NAME` ç”¨æ­¥éª¤ 5 ä¸­å®šä¹‰çš„æ•°æ®åº“åç§°ä»£æ›¿
- `DB_ADMIN_USER`ç”¨æ­¥éª¤ 4 ä¸­è®¾ç½®çš„æ•°æ®åº“ç®¡ç†ç”¨æˆ·`prisma`ä»£æ›¿
- `DB_ADMIN_PASSWORD`ä½¿ç”¨æ­¥éª¤ 4 ä¸­è®¾ç½®çš„æ•°æ®åº“ç®¡ç†å¯†ç 

è®¾ç½®å®Œæ‰€æœ‰çš„å€¼åï¼Œå°†å…¶è®¾ç½®ä¸ºæœ¬åœ°ç¯å¢ƒå˜é‡:

```terminal copy
export DATABASE_URL="sqlserver://DB_SERVER_NAME.database.windows.net:1433;database=DB_NAME;user=DB_ADMIN_USER@DB_SERVER_NAME;password={DB_ADMIN_PASSWORD};encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30"
```

## 10. åˆ›å»º Azure Functions æœ¬åœ°é…ç½®

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å°†ä¸º Azure Functions åˆ›å»º[æœ¬åœ°é…ç½®]ï¼ˆhttps://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local#local-settings-fileï¼‰æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶ç”¨äºå®šä¹‰æœ¬åœ°é…ç½®ï¼Œå¦‚å‡½æ•°å’Œè¿è¡Œæ—¶çš„ç¯å¢ƒå˜é‡ - åœ¨è¿™é‡Œæ˜¯ Node.jsã€‚

ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`local.settings.json`çš„æ–‡ä»¶ï¼š

```command copy
touch local.settings.json
```

å¹¶åœ¨å…¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹:

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "",
    "FUNCTIONS_WORKER_RUNTIME": "node"
  }
}
```

## 11. åˆ›å»º database schema

è®¾ç½®å¥½`DATABASE_URL`ç¯å¢ƒå˜é‡åï¼Œä½ å°†ä½¿ç”¨[`prisma migrate deploy`](/reference/api-reference/command-reference#migrate-deploy)å‘½ä»¤åˆ›å»ºæ•°æ®åº“æ¨¡å¼ã€‚

> **æ³¨æ„ï¼š** `prisma migrate deploy`å‘½ä»¤å°†è¿è¡Œ`prisma/migrations`æ–‡ä»¶å¤¹ä¸­çš„è¿ç§»æ–‡ä»¶ã€‚åˆå§‹è¿ç§»å·²ç»åŒ…å«åœ¨ä¾‹å­ä¸­ã€‚è¦äº†è§£æ›´å¤šå…³äºå¦‚ä½•åˆ›å»ºè¿ç§»çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[Prisma Migrate](https://www.prisma.io/docs/concepts/components/prisma-migrate)æ–‡æ¡£ã€‚

è¿è¡Œä¸‹é¢çš„å‘½ä»¤æ¥åˆ›å»ºæ•°æ®åº“æ¨¡å¼:

```terminal copy
npx prisma migrate deploy
```

**æ£€æŸ¥ç‚¹:** `prisma migrate deploy` æ‰§è¡Œååº”è¯¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹:

```no-lines
1 migration found in prisma/migrations

The following migration have been applied:

migrations/
  â””â”€ 20210322111219_init/
    â””â”€ migration.sql

All migrations have been successfully applied.
```

## 12. å°† DATABASE_URL ç¯å¢ƒå˜é‡æš´éœ²ç»™å‡½æ•°

åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œä½ å°†æŠŠ`DATABASE_URL`ç¯å¢ƒå˜é‡æš´éœ²ç»™å‡½æ•°ï¼Œä»¥ä¾¿ Prisma èƒ½å¤Ÿè¿æ¥åˆ°æ•°æ®åº“ã€‚åœ¨ Azure Functions ä¸­ï¼Œç¯å¢ƒå˜é‡æ˜¯ç”¨[åº”ç”¨è®¾ç½®](https://docs.microsoft.com/en-us/azure/azure-functions/functions-app-settings)è®¾ç½®çš„ã€‚

åœ¨ç”¨æ­¥éª¤ 8 ä¸­åˆ›å»ºçš„**å‡½æ•°åº”ç”¨**çš„åç§°æ›¿æ¢`FUNCTION_APP_NAME_FROM_STEP_8`åï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤:

```terminal copy
az functionapp config appsettings set --name FUNCTION_APP_NAME_FROM_STEP_8 --resource-group prisma-azure-example --settings DATABASE_URL=$DATABASE_URL
```

è¯¥å‘½ä»¤å°†ä½¿ç”¨æ­¥éª¤ 9 ä¸­è®¾ç½®çš„æœ¬åœ°å®šä¹‰çš„`DATABASE_URL`ç¯å¢ƒå˜é‡æ¥è®¾ç½®`DATABASE_URL`åº”ç”¨ç¨‹åºã€‚

> **æ³¨æ„:** é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨è®¾ç½®æ˜¯ä¸åŠ å¯†çš„ã€‚ç”±äº`DATABASE_URL`åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨[Azure çš„å¯†é’¥åº“](https://docs.microsoft.com/en-us/azure/app-service/app-service-key-vault-references?toc=/azure/azure-functions/toc.json)æ›´å®‰å…¨åœ°å­˜å‚¨å®ƒã€‚

æ­å–œä½ ï¼ä½ å·²ç»åˆ›å»ºäº†æ‰€æœ‰å¿…è¦çš„èµ„æºå’Œé…ç½®ã€‚ä½ å·²ç»åˆ›å»ºäº†æ‰€æœ‰å¿…è¦çš„èµ„æºå’Œé…ç½®ï¼Œè¿™æ„å‘³ç€ä½ çš„ API å·²ç»å‡†å¤‡å¥½è¢«éƒ¨ç½²ã€‚

## 13. å‘å¸ƒå‡½æ•°åº”ç”¨

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å°†ç”Ÿæˆ Prisma å®¢æˆ·ç«¯å¹¶éƒ¨ç½²åŠŸèƒ½ï¼š

ä»é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤:

```terminal copy
npx prisma generate
```

è¯¥å‘½ä»¤å°†ç”Ÿæˆ Prisma å®¢æˆ·ç«¯åˆ° node_modules æ–‡ä»¶å¤¹ä¸­ã€‚

è¦éƒ¨ç½²è¿™äº›åŠŸèƒ½ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```terminal copy
npx func azure functionapp publish FUNCTION_APP_NAME
```

> **æ£€æŸ¥ç‚¹:** å¦‚æœè¿™äº›åŠŸèƒ½å·²ç»æˆåŠŸéƒ¨ç½²ï¼Œä½ åº”è¯¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡º:

```no-lines
Getting site publishing info...
Uploading package...
Uploading 67.24 MB [##############################################################################]
Upload completed successfully.
Deployment completed successfully.
Syncing triggers...
Functions in FUNCTION_APP_NAME:
    CreatePost - [httpTrigger]
        Invoke url: https://FUNCTION_APP_NAME.azurewebsites.net/api/post
    CreateUser - [httpTrigger]
        Invoke url: https://FUNCTION_APP_NAME.azurewebsites.net/api/user
    DeletePost - [httpTrigger]
        Invoke url: https://FUNCTION_APP_NAME.azurewebsites.net/api/post/{postid}
    FilterPosts - [httpTrigger]
        Invoke url: https://FUNCTION_APP_NAME.azurewebsites.net/api/filterposts
    GetFeed - [httpTrigger]
        Invoke url: https://FUNCTION_APP_NAME.azurewebsites.net/api/feed
    GetPost - [httpTrigger]
        Invoke url: https://FUNCTION_APP_NAME.azurewebsites.net/api/post/{postid}
    PublishPost - [httpTrigger]
        Invoke url: https://FUNCTION_APP_NAME.azurewebsites.net/api/publish/{postid}
```

æ­å–œä½  ğŸŠ! å¦‚æœä½ å·²ç»èµ°åˆ°äº†è¿™ä¸€æ­¥ï¼Œä½ å·²ç»æˆåŠŸåœ°å°†åŸºäº Prisma çš„ REST API éƒ¨ç½²åˆ° Azure Functions ä¸­ï¼Œå®ƒä½¿ç”¨ Azure SQL ä½œä¸ºæ•°æ®åº“ã€‚

åœ¨ä¸‹ä¸€æ­¥ï¼Œä½ å°†æµ‹è¯•è¿™äº›å‡½æ•°ï¼Œå¹¶ä»”ç»†çœ‹çœ‹è¿™äº›å‡½æ•°æ˜¯å¦‚ä½•å®ç°çš„ã€‚

## 14. æµ‹è¯•å·²éƒ¨ç½²çš„å‡½æ•°

åœ¨è¿™ä¸€æ­¥ï¼Œä½ å°†ä½¿ç”¨ä¸Šä¸€æ­¥çš„ URL æ¥æµ‹è¯• API çš„ä¸åŒç«¯ç‚¹ã€‚

é¦–å…ˆï¼Œç”¨ curl å‘*CreateUser*ç«¯ç‚¹å‘å‡ºä¸€ä¸ª POST HTTP è¯·æ±‚ï¼š

```terminal copy
curl --request POST --data '{"email":"alice@prisma.io","name":"Alice"}' https://FUNCTION_APP_NAME.azurewebsites.net/api/user
```

> **æ³¨æ„ï¼š**å°† URL ä¸­çš„**`FUNCTION_APP_NAME`**æ›¿æ¢ä¸ºä½ åœ¨æ­¥éª¤ 8 ä¸­é€‰æ‹©çš„åº”ç”¨ç¨‹åºåç§°ã€‚

å¦‚æœè¯·æ±‚æˆåŠŸï¼Œä½ åº”è¯¥çœ‹åˆ°è¿”å›åˆ›å»ºçš„ç”¨æˆ·å¯¹è±¡ï¼š

```json
{
  "createdAt": "2021-03-02T14:48:15.746Z",
  "email": "alice@prisma.io",
  "id": 1,
  "name": "Alice"
}
```

ä¸è¯¥å‡½æ•°ç›¸å…³çš„æ–‡ä»¶å¯ä»¥åœ¨`CreateUser`æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ã€‚

- `function.json`: å‡½æ•°é…ç½®ï¼Œä¾‹å¦‚ HTTP æ–¹æ³•ã€è·¯å¾„å’Œè¿”å›å€¼
- `index.js`: Prisma å®¢æˆ·ç«¯ç”¨äºåœ¨ Azure SQL æ•°æ®åº“ä¸­åˆ›å»ºç”¨æˆ·çš„å‡½æ•°å¤„ç†ç¨‹åºã€‚

ç°åœ¨ï¼Œå°è¯•ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªä¸ä½ åˆšåˆšåˆ›å»ºçš„ç”¨æˆ·ç›¸å…³çš„*post*:

```terminal copy
curl --request POST --data '{"title":"Prisma with Azure","content":"","authorEmail":"alice@prisma.io"}' https://FUNCTION_APP_NAME.azurewebsites.net/api/post
```

å¦‚æœè¯·æ±‚æˆåŠŸï¼Œä½ åº”è¯¥çœ‹åˆ°è¿”å›åˆ›å»ºçš„*post*å¯¹è±¡:

```json
{
  "id": 1,
  "createdAt": "2021-03-02T17:09:53.160Z",
  "updatedAt": "2021-03-02T17:09:53.161Z",
  "title": "Prisma with Azure",
  "content": "",
  "published": false,
  "authorId": 1
}
```

è¦æ›´æ–°å¸–å­çš„`published`å­—æ®µï¼Œè¯·æå‡ºä»¥ä¸‹è¯·æ±‚:

```terminal copy
curl --request PUT https://FUNCTION_APP_NAME.azurewebsites.net/api/publish/1
```

å¦‚æœè¯·æ±‚æˆåŠŸï¼Œä½ åº”è¯¥çœ‹åˆ°æ›´æ–°çš„*post*å¯¹è±¡:

```json
{
  "authorId": 1,
  "content": "",
  "createdAt": "2021-03-02T17:09:53.160Z",
  "id": 1,
  "published": true,
  "title": "Prisma with Azure",
  "updatedAt": "2021-03-03T10:07:11.047Z"
}
```

æœ€åï¼Œä¸ºäº†æµ‹è¯•*feed*ç«¯ç‚¹ï¼Œå‘èµ·ä»¥ä¸‹è¯·æ±‚:

```terminal copy
curl https://FUNCTION_APP_NAME.azurewebsites.net/api/feed
```

å¦‚æœè¯·æ±‚æˆåŠŸï¼Œä½ åº”è¯¥çœ‹åˆ°ä½ åˆ›å»ºçš„å¸–å­å’Œç›¸å…³çš„ä½œè€…:

```json
[
  {
    "author": {
      "createdAt": "2021-03-02T14:48:15.746Z",
      "email": "alice@prisma.io",
      "id": 1,
      "name": "Alice"
    },
    "authorId": 1,
    "content": "",
    "createdAt": "2021-03-02T17:09:53.160Z",
    "id": 1,
    "published": true,
    "title": "Prisma with Azure",
    "updatedAt": "2021-03-03T10:07:11.047Z"
  }
]
```

## åœ¨æœ¬åœ°å¼€å‘å’Œè°ƒè¯•å‡½æ•°

åœ¨å®ç° Azure Functions æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Azure Functions æ ¸å¿ƒå·¥å…·çš„å‡½æ•°è¿è¡Œæ—¶é—´å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒã€‚è¿™æ ·ä¸€æ¥ï¼Œä½ å°±å¯ä»¥åœ¨æœ¬åœ°æµ‹è¯•å’Œè°ƒè¯•å‡½æ•°çš„å®ç°ã€‚

è¦å¯åŠ¨å‡½æ•°è¿è¡Œæ—¶ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```terminal copy
npx func start
```

è¯¥å‘½ä»¤å¯åŠ¨ä¸€ä¸ªæœ¬åœ°æœåŠ¡å™¨ï¼Œå…è®¸ä½ è°ƒç”¨é¡¹ç›®ä¸­çš„ä»»ä½•å‡½æ•°ã€‚

ä½ å¯ä»¥å°†ç¯å¢ƒå˜é‡æ·»åŠ åˆ°é¡¹ç›®æ ¹éƒ¨çš„`local.settings.json`æ–‡ä»¶ä¸­çš„`Values`å¯¹è±¡ä¸­ï¼Œä»è€Œå°†ç¯å¢ƒå˜é‡æ³¨å…¥å‡½æ•°ä¸­ã€‚

## ä¸ºå¼€å‘è®¾ç½®ä¸€ä¸ªæœ¬åœ°æ•°æ®åº“

åœ¨æœ¬åœ°å¼€å‘æ—¶ï¼Œä½ åº”è¯¥è€ƒè™‘è¿è¡Œä¸€ä¸ªæœ¬åœ°çš„ Microsoft SQL Server å®ä¾‹ã€‚[è™½ç„¶ Microsoft SQL Server ä¸ Azure SQL ä¸åŒï¼Œä½†ä¸¤è€…ä¹‹é—´æœ‰å¾ˆé«˜çš„å…¼å®¹æ€§ã€‚]ï¼ˆhttps://docs.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overviewï¼‰ã€‚

å»ºç«‹æœ¬åœ° Microsoft SQL Server çš„æœ€å¿«æ·æ–¹å¼æ˜¯ä½¿ç”¨ Dockerã€‚è¯·æŸ¥çœ‹[Microsoft SQL Server å®ä¾‹](https://github.com/prisma/prisma-examples/tree/latest/databases/sql-server)ï¼Œäº†è§£æ›´å¤šå…³äºå¦‚ä½•è®¾ç½®çš„ä¿¡æ¯ã€‚

## å¼•å¯¼ä¸€ä¸ªæ–°çš„å‡½æ•°

å½“ä½ æƒ³åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å¼•å¯¼ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼š

```command copy
npx func function new --language JavaScript --template "HTTP trigger" --name FUNCTION_NAME
```

è¯¥å‘½ä»¤åˆ›å»ºä¸€ä¸ªåŒ…å«`index.js`å’Œ`function.json`æ–‡ä»¶çš„æ–‡ä»¶å¤¹ã€‚

## Summary

æ­å–œä½ ï¼ä½ å·²ç»æˆåŠŸåœ°å°† REST API éƒ¨ç½²åˆ° Azure Functionsï¼Œå¹¶ä½¿ç”¨ Prisma Client å¤„ç†å¯¹ Azure SQL æ•°æ®åº“çš„æŸ¥è¯¢ã€‚ä½ å·²ç»æˆåŠŸåœ°å°† REST API éƒ¨ç½²åˆ° Azure Functionsï¼Œå¹¶ä½¿ç”¨ Prisma Client æ¥å¤„ç†å¯¹ Azure SQL æ•°æ®åº“çš„æ•°æ®åº“æŸ¥è¯¢ã€‚

è¦æ·±å…¥äº†è§£ Prisma å®¢æˆ·ç«¯çš„ APIï¼Œè¯·æ¢ç´¢å‡½æ•°å¤„ç†ç¨‹åºï¼Œå¹¶æŸ¥çœ‹[Prisma Client API å‚è€ƒèµ„æ–™](/reference/api-reference/prisma-client-reference)ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶æœ¬æŒ‡å—ä½¿ç”¨ Azure CLI æ¥åˆ›å»ºæ‰€æœ‰çš„èµ„æºï¼Œä½†è¿™ä¹Ÿå¯ä»¥é€šè¿‡ Azure Portal UI æˆ– VSCode æ‰©å±•æ¥å®ç°ï¼Œå®ƒæ”¯æŒç›´æ¥ä» VSCode è¿›è¡Œéƒ¨ç½²ã€‚

ä½œä¸ºä¸‹ä¸€æ­¥ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨[GitHub Actions](https://docs.microsoft.com/en-us/azure/azure-functions/functions-how-to-github-actions?tabs=javascript)å®ç°æŒç»­äº¤ä»˜ç®¡é“ï¼Œä»¥ä¾¿ä» GitHub ä»“åº“è‡ªåŠ¨éƒ¨ç½²è¿‡ç¨‹ã€‚

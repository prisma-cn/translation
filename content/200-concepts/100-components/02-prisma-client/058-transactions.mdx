---
title: 'äº‹åŠ¡å’Œæ‰¹å¤„ç†æŸ¥è¯¢'
metaTitle: 'äº‹åŠ¡å’Œæ‰¹å¤„ç†æŸ¥è¯¢ (å‚è€ƒ)'
metaDescription: 'æ­¤é¡µé¢è§£é‡Š Prisma Client çš„å½“å‰äº‹åŠ¡ APIã€‚'
---

<TopBlock>

æ•°æ®åº“äº‹åŠ¡æ˜¯æŒ‡ä¸€ç³»åˆ—è¯»/å†™æ“ä½œï¼Œè¿™äº›æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ _ä¿è¯_ æˆåŠŸæˆ–å¤±è´¥ã€‚æœ¬èŠ‚ä»‹ç» Prisma Client API æ”¯æŒäº‹åŠ¡çš„æ–¹å¼ã€‚

- æœ‰å…³æ›´æ·±å…¥çš„ç¤ºä¾‹å’Œç”¨ä¾‹ï¼Œè¯·å‚é˜…ğŸ“– [äº‹åŠ¡æŒ‡å—](../../../guides/performance-and-optimization/prisma-client-transactions-guide)ã€‚
- æœ‰å…³ä¸€èˆ¬äº‹åŠ¡ä»¥åŠ Prisma å½“å‰è§£å†³æ–¹æ¡ˆèƒŒåçš„åŸå› çš„ä¿¡æ¯ï¼Œè¯·å‚é˜…âœ [åšå®¢ï¼šPrisma å¦‚ä½•æ”¯æŒäº‹åŠ¡](https://www.prisma.io/blog/how-prisma-supports-transactions-x45s1d5l0ww1/).

</TopBlock>

## åµŒå¥—å†™å…¥

[åµŒå¥—å†™å…¥](relation-queries#nested-writes) å…è®¸ä½ ä½¿ç”¨å¤šä¸ª _æ“ä½œ_ æ‰§è¡Œå•ä¸ª Prisma Client API è°ƒç”¨ï¼Œè¿™äº›æ“ä½œæ¶‰åŠå¤šä¸ª [_ç›¸å…³çš„_](../prisma-schema/relations) è®°å½•ã€‚ä¾‹å¦‚ï¼Œåˆ›å»º _ç”¨æˆ·_ å’Œ _post_ æˆ–æ›´æ–° _è®¢å•_ å’Œ _å‘ç¥¨_ã€‚Prisma Client ç¡®ä¿æ‰€æœ‰æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“æˆåŠŸæˆ–å¤±è´¥ã€‚

ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†å¸¦æœ‰ `create` çš„åµŒå¥—å†™å…¥ï¼š

```ts
// åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­åˆ›å»ºä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå¸–å­çš„æ–°ç”¨æˆ·
const newUser: User = await prisma.user.create({
  data: {
    email: 'alice@prisma.io',
    posts: {
      create: [
        { title: 'Join the Prisma Slack on https://slack.prisma.io' },
        { title: 'Follow @prisma on Twitter' },
      ],
    },
  },
})
```

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¸¦æœ‰ `update` çš„åµŒå¥—å†™å…¥ï¼š

```ts
// åœ¨å•ä¸ªäº‹åŠ¡ä¸­æ›´æ”¹å¸–å­çš„ä½œè€…
const updatedPost: Post = await prisma.post.update({
  where: { id: 42 },
  data: {
    author: {
      connect: { email: 'alice@prisma.io' },
    },
  },
})
```

> æ›´å¤šç¤ºä¾‹è¯·å‚è€ƒ ğŸ“– [äº‹åŠ¡æŒ‡å—](../../../guides/performance-and-optimization/prisma-client-transactions-guide#nested-writes)ã€‚

## æ‰¹å¤„ç†/æ‰¹é‡æ“ä½œ

ä»¥ä¸‹æ‰¹é‡æ“ä½œä½œä¸ºäº‹åŠ¡è¿è¡Œï¼š

- `deleteMany`
- `updateMany`
- `createMany`

> æ›´å¤šç¤ºä¾‹è¯·å‚è€ƒ ğŸ“– [äº‹åŠ¡æŒ‡å—](../../../guides/performance-and-optimization/prisma-client-transactions-guide#bulk-operations)ã€‚

## The <inlinecode>$transaction</inlinecode> API

ä»¥ä¸‹æŸ¥è¯¢è¿”å›ä¸æä¾›çš„è¿‡æ»¤å™¨åŒ¹é…çš„æ‰€æœ‰å¸–å­ä»¥åŠæ‰€æœ‰å¸–å­çš„è®¡æ•°ï¼š

```ts
const [posts, totalPosts] = await prisma.$transaction([
  prisma.post.findMany({ where: { title: { contains: 'prisma' } } }),
  prisma.post.count(),
])
```

ä½ å¯ä»¥åœ¨ `$transaction` ä¸­ä½¿ç”¨ `$queryRaw` å’Œ `$executeRaw` ï¼š

```ts
const [userList, updateUser] = await prisma.$transaction([
  prisma.$queryRaw`SELECT 'title' FROM User`,
  prisma.$executeRaw`UPDATE User SET name = 'Hello' WHERE id = 2;`,
])
```

æ“ä½œæœ¬èº«ä¸æ˜¯åœ¨æ‰§è¡Œæ—¶ç«‹å³ç­‰å¾…æ¯ä¸ªæ“ä½œçš„ç»“æœï¼Œè€Œæ˜¯å…ˆå­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œç„¶åé€šè¿‡åä¸º `$transaction` çš„æ–¹æ³•æäº¤ç»™æ•°æ®åº“ã€‚Prisma Client å°†ç¡®ä¿æ‰€æœ‰ä¸‰ä¸ª `create` æ“ä½œéƒ½æˆåŠŸï¼Œæˆ–è€…æ²¡æœ‰ä¸€ä¸ªæˆåŠŸã€‚

> **æ³¨æ„**ï¼šæ“ä½œæ ¹æ®å…¶åœ¨äº‹åŠ¡ä¸­çš„é¡ºåºæ‰§è¡Œã€‚åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨æŸ¥è¯¢ä¸ä¼šå½±å“æŸ¥è¯¢æœ¬èº«çš„æ“ä½œé¡ºåºã€‚

> 
> å‚è€ƒğŸ“– [äº‹åŠ¡æŒ‡å—](../../../guides/performance-and-optimization/prisma-client-transactions-guide#transaction-api) äº†è§£æ›´å¤šç¤ºä¾‹ã€‚

### äº¤äº’å¼äº‹åŠ¡ï¼ˆåœ¨é¢„è§ˆç‰ˆï¼‰

æœ‰æ—¶ï¼Œä½ éœ€è¦æ›´å¤šåœ°æ§åˆ¶äº‹åŠ¡ä¸­æ‰§è¡Œçš„æŸ¥è¯¢ã€‚

å½“ä¸€ä¸ªæŸ¥è¯¢çš„ç»“æœä¾èµ–äºå¦ä¸€ä¸ªæŸ¥è¯¢ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨å•ä¸ªäº‹åŠ¡ä¸­è¿è¡Œä¸¤ä¸ªæŸ¥è¯¢æ—¶ï¼Œé€šå¸¸ä½¿ç”¨äº¤äº’å¼äº‹åŠ¡ã€‚

ä¸ºäº†æ”¯æŒæ­¤ç”¨ä¾‹åŠæ›´å¤šï¼Œä½ å¯ä»¥é€šè¿‡åœ¨ Prisma Schema çš„ç”Ÿæˆå™¨ä¸­æ·»åŠ  `interactiveTransactions` æ¥å¯ç”¨äº¤äº’å¼äº‹åŠ¡ï¼š

```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["interactiveTransactions"]
}
```

ç„¶åä½ å¯ä»¥å°†å¼‚æ­¥å‡½æ•°ä¼ é€’åˆ° [`$transaction`](../../../guides/performance-and-optimization/prisma-client-transactions-guide#transaction-api)ã€‚

ä»¥ä¸‹æ˜¯åœ¨çº¿è´­ä¹°ç”µå½±ç¥¨çš„ç¤ºä¾‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœŸçš„ä¸æƒ³æŠŠåŒä¸€å¼ ç¥¨å–ä¸¤æ¬¡ï¼š

```tsx
import { Ticket } from 'prisma'

const userEmail = 'alice@prisma.io'
const movieName = 'October Sky'

// å¼€å§‹ä¸€ä¸ªäº‹åŠ¡
const ticket: Ticket = await prisma.$transaction(async (prisma) => {
  // æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ç”µå½±ç¥¨
  const availableTicket = await prisma.ticket.findFirst({
    where: {
      claimedBy: null,
      movie: {
        name: movieName,
      },
    },
  })

  // å¦‚æœæ²¡æœ‰å¯ç”¨çš„ç”µå½±ç¥¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸
  if (!availableTicket) {
    // äº‹åŠ¡å°†è¢«å›æ»š
    throw new Error(`Oh no! ${movieName} is all booked.`)
  }

  // ç´¢å–ç¥¨æ®ã€æäº¤äº‹åŠ¡å¹¶è¿”å›ç»“æœ
  return prisma.ticket.update({
    data: {
      claimedBy: userEmail,
    },
    where: {
      id: availableTicket.id,
    },
  })
})
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ`findFirst` å’Œ `update` æŸ¥è¯¢éƒ½åœ¨æ•°æ®åº“äº‹åŠ¡ä¸­è¿è¡Œã€‚å½“åº”ç”¨ç¨‹åºåˆ°è¾¾å‡½æ•°æœ«å°¾æ—¶ï¼Œäº‹åŠ¡å°† **æäº¤** åˆ°æ•°æ®åº“ã€‚

å¦‚æœåº”ç”¨ç¨‹åºåœ¨æ­¤è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œå¼‚æ­¥å‡½æ•°å°†æŠ›å‡ºå¼‚å¸¸å¹¶è‡ªåŠ¨ **å›æ»š** äº‹åŠ¡ã€‚

è¦æ•è·å¼‚å¸¸ï¼Œå¯ä»¥åœ¨ try-catch å—ä¸­åŒ…å« `$transaction`ï¼š

```js
try {
  await prisma.$transaction(async (prisma) => {
    // ä»£ç è¿è¡Œäº†ä¸€ä¸ªäº‹åŠ¡...
  })
} catch (err) {
  // å¤„ç†å›æ»š...
}
```

æ­¤å¤–ï¼Œäº‹åŠ¡ API æ”¯æŒå…·æœ‰ä»¥ä¸‹é…ç½®é€‰é¡¹çš„ç¬¬äºŒä¸ªå‚æ•°ï¼š

- `maxWait`:Prisma Client ç­‰å¾…ä»æ•°æ®åº“è·å–äº‹åŠ¡çš„æœ€é•¿æ—¶é—´ã€‚é»˜è®¤å€¼ä¸º 2 ç§’ã€‚

- `timeout`ï¼šåœ¨å–æ¶ˆå’Œå›æ»šäº¤äº’äº‹åŠ¡ä¹‹å‰ï¼Œå¯ä»¥è¿è¡Œçš„æœ€é•¿æ—¶é—´ã€‚é»˜è®¤å€¼ä¸º 5 ç§’ã€‚

ä¾‹å¦‚ï¼š

```jsx
await prisma.$transaction(
  async (prisma) => {
    // ä»£ç è¿è¡Œäº†ä¸€ä¸ªäº‹åŠ¡...
  },
  {
    maxWait: 5000, // default: 2000
    timeout: 10000, // default: 5000
  }
)
```

<Admonition type="warning">

**è°¨æ…ä½¿ç”¨äº¤äº’å¼äº‹åŠ¡**ã€‚
ä¿æŒäº‹åŠ¡é•¿æ—¶é—´æ‰“å¼€ä¼šæœ‰æŸæ•°æ®åº“æ€§èƒ½ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´æ­»é”ã€‚
å°½é‡é¿å…æ‰§è¡Œç½‘ç»œè¯·æ±‚å’Œåœ¨å†…éƒ¨æ‰§è¡Œç¼“æ…¢çš„æŸ¥è¯¢äº‹åŠ¡åŠŸèƒ½ã€‚
æˆ‘ä»¬å»ºè®®ä½ å°½å¯èƒ½çš„å¿«è¿›å¿«å‡ºï¼

</Admonition>

## äº‹åŠ¡éš”ç¦»çº§åˆ«

å½“å‰æ— æ³•åœ¨ Prisma çº§åˆ«é…ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ŒPrisma ä¹Ÿæœªæ˜¾å¼è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚

- [PostgreSQL ä¸­çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«](https://www.postgresql.org/docs/9.3/runtime-config-client.html#GUC-DEFAULT-TRANSACTION-ISOLATION)
- [SQL Server ä¸­çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«](https://docs.microsoft.com/en-us/sql/t-sql/statements/set-transaction-isolation-level-transact-sql?view=sql-server-ver15)
- [MySQL ä¸­çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«](https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html)

## åŠ å…¥ GitHub ä¸Šçš„å¯¹è¯

å¦‚æœä½ å¸Œæœ›çœ‹åˆ°å°†æ¥æ”¯æŒçš„äº‹åŠ¡ï¼Œ[è¯·åŠ å…¥å…³äº GitHub çš„è®¨è®º](https://github.com/prisma/prisma-client-js/issues/349)ã€‚

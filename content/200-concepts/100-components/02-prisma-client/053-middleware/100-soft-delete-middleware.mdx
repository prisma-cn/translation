---
title: 'è½¯åˆ é™¤ä¸­é—´ä»¶'
metaTitle: 'è½¯åˆ é™¤ä¸­é—´ä»¶ (æ¦‚å¿µ)'
metaDescription: 'å¦‚ä½•ä½¿ç”¨ä¸­é—´ä»¶æ‹¦æˆªåˆ é™¤å¹¶è®¾ç½®å­—æ®µå€¼ï¼Œè€Œä¸æ˜¯åˆ é™¤è®°å½•ã€‚'
tocDepth: 3
---

<TopBlock>

ä¸‹é¢çš„ç¤ºä¾‹ä½¿ç”¨ä¸­é—´ä»¶æ‰§è¡Œ **è½¯åˆ é™¤**ï¼Œè¿™æ„å‘³ç€è®°å½• **æ ‡è®°ä¸ºå·²åˆ é™¤**ï¼Œæ–¹æ³•æ˜¯å°†ç±»ä¼¼ `å·²åˆ é™¤` çš„å­—æ®µæ›´æ”¹ä¸º `çœŸ` ï¼Œè€Œä¸æ˜¯å®é™…ä»æ•°æ®åº“ä¸­åˆ é™¤ã€‚ä½¿ç”¨è½¯åˆ é™¤çš„åŸå› åŒ…æ‹¬ï¼š

- æ³•è§„è¦æ±‚ï¼Œè¿™æ„å‘³ç€ä½ å¿…é¡»å°†æ•°æ®ä¿ç•™ä¸€æ®µæ—¶é—´

- 'åºŸå¼ƒ' / 'åƒåœ¾ç®±' åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·è¿˜åŸå·²åˆ é™¤çš„å†…å®¹

æœ¬ä¾‹ä½¿ç”¨ä»¥ä¸‹ schema - æ³¨æ„ `Post` æ¨¡å‹ä¸Šçš„ `deleted` å­—æ®µï¼š

```prisma highlight=28;normal
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        Int     @id @default(autoincrement())
  name      String?
  email     String  @unique
  posts     Post[]
  followers User[]  @relation("UserToUser")
  User      User?   @relation("UserToUser", fields: [userId], references: [id])
  userId    Int?
}

model Post {
  id      Int     @id @default(autoincrement())
  title   String
  content String?
  User    User?   @relation(fields: [userId], references: [id])
  userId  Int?
  tags    Tag[]
  views   Int     @default(0)
  deleted Boolean @default(false)
}

model Category {
  id             Int        @id @default(autoincrement())
  parentCategory Category?  @relation("CategoryToCategory", fields: [categoryId], references: [id])
  Category       Category[] @relation("CategoryToCategory")
  categoryId     Int?
}

model Tag {
  tagName String @id // Must be unique
  posts   Post[]
}
```

</TopBlock>

## æ­¥éª¤ 1 ï¼š è®°å½•çš„å­˜å‚¨çŠ¶æ€

å°†åä¸º `deleted` çš„å­—æ®µæ·»åŠ åˆ° `Post` æ¨¡å‹ä¸­ã€‚æ ¹æ®ä½ çš„è¦æ±‚ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸¤ç§å­—æ®µç±»å‹ï¼š

- `Boolean` é»˜è®¤å€¼ä¸º `false`:

  ```prisma highlight=4;normal
  model Post {
    id      Int     @id @default(autoincrement())
    ...
    deleted Boolean @default(false)
  }
  ```

- åˆ›å»ºä¸€ä¸ªå¯ä¸ºç©ºçš„ `DateTime` å­—æ®µï¼Œä»¥ä¾¿å‡†ç¡®åœ°çŸ¥é“è®°å½• _ä½•æ—¶_ è¢«æ ‡è®°ä¸ºå·²åˆ é™¤ - `NULL` è¡¨ç¤ºè®°å½•å°šæœªè¢«åˆ é™¤ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåˆ é™¤è®°å½•æ—¶è¿›è¡Œå­˜å‚¨å¯èƒ½æ˜¯ä¸€é¡¹æ³•è§„è¦æ±‚ï¼š

  ```prisma highlight=4;normal
  model Post {
    id      Int       @id @default(autoincrement())
    ...
    deleted DateTime?
  }
  ```

> **æ³¨**ï¼šä½¿ç”¨ä¸¤ä¸ªå•ç‹¬çš„å­—æ®µï¼ˆ`isDeleted` å’Œ `deletedDate`ï¼‰å¯èƒ½ä¼šå¯¼è‡´è¿™ä¸¤ä¸ªå­—æ®µä¸åŒæ­¥ - ä¾‹å¦‚ï¼Œè®°å½•å¯èƒ½è¢«æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œä½†æ²¡æœ‰å…³è”çš„æ—¥æœŸã€‚ï¼‰

ä¸ºäº†ç®€å•èµ·è§ï¼Œæ­¤ç¤ºä¾‹ä½¿ç”¨ `Boolean` å­—æ®µç±»å‹ã€‚

## æ­¥éª¤ 2ï¼šè½¯åˆ é™¤ä¸­é—´ä»¶

æ·»åŠ æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡çš„ä¸­é—´ä»¶ï¼š

- æˆªå– `Post` æ¨¡å‹çš„ `delete` å’Œ `deleteMany` æŸ¥è¯¢

- å°† 'params.action' åˆ†åˆ«æ›´æ”¹ä¸º `update` å’Œ `updateMany`

- å¼•å…¥ `data` å‚æ•°å¹¶è®¾ç½® `{deleted:true}`ï¼Œä¿ç•™å…¶ä»–è¿‡æ»¤å™¨å‚æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

è¿è¡Œä»¥ä¸‹ç¤ºä¾‹æµ‹è¯•è½¯åˆ é™¤ä¸­é—´ä»¶ï¼š

```ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient({})

async function main() {
  /***********************************/
  /* è½¯åˆ é™¤ä¸­é—´ä»¶ */
  /***********************************/

  prisma.$use(async (params, next) => {
    // æ£€æŸ¥ä¼ å…¥æŸ¥è¯¢ç±»å‹
    if (params.model == 'Post') {
      if (params.action == 'delete') {
        // åˆ é™¤æŸ¥è¯¢
        // å°†æ“ä½œæ›´æ”¹ä¸ºæ›´æ–°
        params.action = 'update'
        params.args['data'] = { deleted: true }
      }
      if (params.action == 'deleteMany') {
        // åˆ é™¤è®¸å¤šæŸ¥è¯¢
        params.action = 'updateMany'
        if (params.args.data != undefined) {
          params.args.data['deleted'] = true
        } else {
          params.args['data'] = { deleted: true }
        }
      }
    }
    return next(params)
  })

  /***********************************/
  /* æµ‹è¯• */
  /***********************************/

  const titles = [
    { title: 'How to create soft delete middleware' }, //å¦‚ä½•åˆ›å»ºè½¯åˆ é™¤ä¸­é—´ä»¶
    { title: 'How to install Prisma' }, //å¦‚ä½•å®‰è£… Prisma
    { title: 'How to update a record' }, //å¦‚ä½•æ›´æ–°ä¸€æ¡è®°å½•
  ]

  console.log('\u001b[1;34mSTARTING SOFT DELETE TEST \u001b[0m') //å¼€å§‹è½¯åˆ é™¤æµ‹è¯•
  console.log('\u001b[1;34m#################################### \u001b[0m')

  let i = 0
  let posts = new Array()

  // æ¯æ¬¡åˆ›å»º 3 ç¯‡å¸¦æœ‰éšæœºåˆ†é…æ ‡é¢˜çš„æ–°å¸–å­
  for (i == 0; i < 3; i++) {
    const createPostOperation = prisma.post.create({
      data: titles[Math.floor(Math.random() * titles.length)],
    })
    posts.push(createPostOperation)
  }

  var postsCreated = await prisma.$transaction(posts)

  console.log(
    'Posts created with IDs: ' +
      '\u001b[1;32m' +
      postsCreated.map((x) => x.id) +
      '\u001b[0m'
  )

  // ä»æ•°ç»„ä¸­åˆ é™¤ç¬¬ä¸€ç¯‡å¸–å­
  const deletePost = await prisma.post.delete({
    where: {
      id: postsCreated[0].id, // Random ID
    },
  })

  // åˆ é™¤åä¸¤ä¸ªå¸–å­
  const deleteManyPosts = await prisma.post.deleteMany({
    where: {
      id: {
        in: [postsCreated[1].id, postsCreated[2].id],
      },
    },
  })

  const getPosts = await prisma.post.findMany({
    where: {
      id: {
        in: postsCreated.map((x) => x.id),
      },
    },
  })

  console.log()

  console.log(
    'Deleted post with ID: ' + '\u001b[1;32m' + deletePost.id + '\u001b[0m' //å·²åˆ é™¤ ID ä¸º {} çš„å¸–å­
  )
  console.log(
    'Deleted posts with IDs: ' + //å·²åˆ é™¤ ID ä¸º {} çš„å¸–å­
      '\u001b[1;32m' +
      [postsCreated[1].id + ',' + postsCreated[2].id] +
      '\u001b[0m'
  )
  console.log()
  console.log(
    'Are the posts still available?: ' + //è¿™äº›å¸–å­è¿˜æœ‰å—ï¼Ÿ
      (getPosts.length == 3
        ? '\u001b[1;32m' + 'Yes!' + '\u001b[0m'
        : '\u001b[1;31m' + 'No!' + '\u001b[0m')
  )
  console.log()
  console.log('\u001b[1;34m#################################### \u001b[0m')
  // 4. ç»Ÿè®¡æ‰€æœ‰å¸–å­
  const f = await prisma.post.findMany({})
  console.log('Number of posts: ' + '\u001b[1;32m' + f.length + '\u001b[0m') //å¸–å­æ•°

  // 5. ç»Ÿè®¡å·²åˆ é™¤çš„å¸–å­
  const r = await prisma.post.findMany({
    where: {
      deleted: true,
    },
  })
  console.log(
    'Number of SOFT deleted posts: ' + '\u001b[1;32m' + r.length + '\u001b[0m' //å·²è½¯åˆ é™¤è´´å­æ•°
  )
}

main()
```

è¯¥ç¤ºä¾‹è¾“å‡ºä»¥ä¸‹å†…å®¹ï¼š

```no-lines
STARTING SOFT DELETE TEST //å¯åŠ¨è½¯åˆ é™¤æµ‹è¯•
####################################
Posts created with IDs: 587,588,589 //ä½¿ç”¨IDåˆ›å»ºçš„å¸–å­: 587,588,589

Deleted post with ID: 587 //å·²åˆ é™¤ ID ä¸º 587 çš„å¸–å­
Deleted posts with IDs: 588,589 //å·²åˆ é™¤ ID ä¸º 588589 çš„å¸–å­

Are the posts still available?: Yes! //è¿™äº›å¸–å­è¿˜æœ‰å—ï¼Ÿï¼šæ˜¯çš„ï¼

####################################
```

<Tip>

æ³¨é‡Šæ‰ä¸­é—´ä»¶ä»¥æŸ¥çœ‹æ¶ˆæ¯æ›´æ”¹ã€‚

</Tip>

âœ” è¿™ç§è½¯åˆ é™¤æ–¹æ³•çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š

- è½¯åˆ é™¤å‘ç”Ÿåœ¨æ•°æ®è®¿é—®çº§åˆ«ï¼Œè¿™æ„å‘³ç€é™¤éä½¿ç”¨åŸå§‹ SQLï¼Œå¦åˆ™æ— æ³•åˆ é™¤è®°å½•

âœ˜ è¿™ç§è½¯åˆ é™¤æ–¹æ³•çš„ç¼ºç‚¹åŒ…æ‹¬ï¼š

- å†…å®¹ä»ç„¶å¯ä»¥è¯»å–å’Œæ›´æ–°ï¼Œé™¤éä½ æ˜ç¡®åœ°æŒ‰ `where: { deleted: false }` è¿›è¡Œè¿‡æ»¤ - åœ¨å…·æœ‰å¤§é‡æŸ¥è¯¢çš„å¤§å‹é¡¹ç›®ä¸­ï¼Œä»æœ‰æ˜¾ç¤ºè½¯åˆ é™¤å†…å®¹çš„é£é™©

- ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨åŸå§‹ SQL åˆ é™¤è®°å½•

<Tip>

ä½ å¯ä»¥åˆ›å»ºè§„åˆ™æˆ–è§¦å‘å™¨ ï¼ˆ[MySQL](https://dev.mysql.com/doc/refman/8.0/en/trigger-syntax.html) å’Œ [PostgreSQL](https://www.postgresql.org/docs/8.1/rules-update.html)ï¼‰ åœ¨æ•°æ®åº“çº§åˆ«é˜²æ­¢åˆ é™¤è®°å½•ã€‚
</Tip>


## æ­¥éª¤ 3ï¼šé€‰æ‹©æ€§åœ°é˜²æ­¢ è¯»å–/æ›´æ–° è½¯åˆ é™¤è®°å½•

åœ¨ç¬¬ 2 æ­¥ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†é˜²æ­¢åˆ é™¤ `Post` è®°å½•çš„ä¸­é—´ä»¶ã€‚ä½†æ˜¯ï¼Œä½ ä»ç„¶å¯ä»¥è¯»å–å’Œæ›´æ–°å·²åˆ é™¤çš„è®°å½•ã€‚æœ¬æ­¥éª¤æ¢è®¨ä¸¤ç§é˜²æ­¢è¯»å–å’Œæ›´æ–°å·²åˆ é™¤è®°å½•çš„æ–¹æ³•ã€‚

> **æ³¨æ„**ï¼šè¿™äº›é€‰é¡¹åªæ˜¯äº’æœ‰åˆ©å¼Šçš„æƒ³æ³•ï¼Œä½ å¯ä»¥é€‰æ‹©åšå®Œå…¨ä¸åŒçš„äº‹æƒ…ã€‚

### é€‰é¡¹ 1ï¼šåœ¨ä½ è‡ªå·±çš„åº”ç”¨ç¨‹åºä»£ç ä¸­å®ç°è¿‡æ»¤å™¨

åœ¨è¯¥é€‰é¡¹ä¸­ï¼š

- Prisma ä¸­é—´ä»¶è´Ÿè´£é˜²æ­¢è®°å½•è¢«åˆ é™¤

- åœ¨è¯»å–å’Œæ›´æ–°æ•°æ®æ—¶ï¼Œä½ è‡ªå·±çš„åº”ç”¨ç¨‹åºä»£ç ï¼ˆå¯èƒ½æ˜¯ GraphQL APIã€REST API æˆ–æ¨¡å—ï¼‰è´Ÿè´£åœ¨å¿…è¦æ—¶ï¼ˆ`{ where: { deleted: false } }`ï¼‰è¿‡æ»¤æ‰å·²åˆ é™¤çš„å¸–å­ï¼Œä¾‹å¦‚ï¼Œ`getPost` GraphQL è§£æå™¨ä»ä¸è¿”å›å·²åˆ é™¤çš„å¸–å­

âœ” è¿™ç§è½¯åˆ é™¤æ–¹æ³•çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š

- å¯¹ Prisma çš„åˆ›å»º/æ›´æ–°æŸ¥è¯¢æ²¡æœ‰ä»»ä½•æ›´æ”¹ - å¦‚æœéœ€è¦ï¼Œä½ å¯ä»¥è½»æ¾è¯·æ±‚åˆ é™¤çš„è®°å½•

- åœ¨ä¸­é—´ä»¶ä¸­ä¿®æ”¹æŸ¥è¯¢å¯èƒ½ä¼šäº§ç”Ÿä¸€äº›æ„å¤–çš„åæœï¼Œä¾‹å¦‚æ›´æ”¹æŸ¥è¯¢è¿”å›ç±»å‹ï¼ˆè¯·å‚è§é€‰é¡¹ 2ï¼‰

âœ˜ è¿™ç§è½¯åˆ é™¤æ–¹æ³•çš„ç¼ºç‚¹åŒ…æ‹¬ï¼š

- åœ¨ä¸¤ä¸ªä¸åŒçš„ä½ç½®ç»´æŠ¤ä¸è½¯åˆ é™¤ç›¸å…³çš„é€»è¾‘

- å¦‚æœä½ çš„ API è¡¨é¢éå¸¸å¤§ï¼Œå¹¶ä¸”ç”±å¤šä¸ªå‚ä¸è€…ç»´æŠ¤ï¼Œåˆ™å¯èƒ½å¾ˆéš¾å¼ºåˆ¶æ‰§è¡ŒæŸäº›ä¸šåŠ¡è§„åˆ™ï¼ˆä¾‹å¦‚ï¼Œå†³ä¸å…è®¸æ›´æ–°å·²åˆ é™¤çš„è®°å½•ï¼‰

### é€‰é¡¹ 2ï¼šä½¿ç”¨ä¸­é—´ä»¶ç¡®å®šå·²åˆ é™¤è®°å½•çš„è¯»å–/æ›´æ–°æŸ¥è¯¢è¡Œä¸º

é€‰é¡¹äºŒä½¿ç”¨ Prisma ä¸­é—´ä»¶é˜²æ­¢è¿”å›è½¯åˆ é™¤è®°å½•ã€‚ä¸‹è¡¨æè¿°äº†ä¸­é—´ä»¶å¦‚ä½•å½±å“æ¯ä¸ªæŸ¥è¯¢ï¼š

| **æŸ¥è¯¢**    | **ä¸­é—´ä»¶é€»è¾‘**                                                                                                                                                                    | **è¿”å›ç±»å‹çš„æ›´æ”¹**       |
| :----------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------- |
| `findUnique` | ğŸ”§ å°†æŸ¥è¯¢æ›´æ”¹ä¸º `findFirst` ï¼ˆå› ä¸ºä½ ä¸èƒ½å°† `deleted: false` è¿‡æ»¤å™¨åº”ç”¨äº `findUnique`ï¼‰ <br /> ğŸ”§ æ·»åŠ  `where: { deleted: false }` è¿‡æ»¤å™¨ä»¥æ’é™¤è½¯åˆ é™¤çš„å¸–å­       | æ²¡å˜                        |
| `findMany`   | ğŸ”§ æ·»åŠ  `where: { deleted: false }` è¿‡æ»¤å™¨ä»¥é»˜è®¤æ’é™¤è½¯åˆ é™¤çš„å¸–å­ <br />ğŸ”§ å…è®¸å¼€å‘äººå‘˜é€šè¿‡æŒ‡å®š **æ˜¾å¼** è¯·æ±‚è½¯åˆ é™¤å¸–å­ `deleted: true` | æ²¡å˜                        |
| `update`     | ğŸ”§ Change query to `updateMany` ï¼ˆå› ä¸ºä½ ä¸èƒ½å°† `deleted: false` è¿‡æ»¤å™¨åº”ç”¨äº `update`ï¼‰ <br /> ğŸ”§ æ·»åŠ  `where: { deleted: false }` è¿‡æ»¤å™¨ä»¥æ’é™¤è½¯åˆ é™¤çš„å¸–å­          | `{ count: n }` instead of `Post` |
| `updateMany` | ğŸ”§ æ·»åŠ  `where: { deleted: false }` è¿‡æ»¤å™¨ä»¥æ’é™¤è½¯åˆ é™¤çš„å¸–å­                                                                                                                 | æ²¡å˜                        |

- ** ä¸ºä»€ä¹ˆå¯ä»¥å°† `findMany` ä¸ `{ where: { deleted: true } }` è¿‡æ»¤å™¨ä¸€èµ·ä½¿ç”¨ï¼Œè€Œä¸æ˜¯ `updateMany` ï¼Ÿ**<br/>

è¿™ä¸ªç‰¹åˆ«çš„ä¾‹å­æ˜¯ä¸ºäº†æ”¯æŒè¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šç”¨æˆ·å¯ä»¥æ¢å¤ä»–ä»¬åˆ é™¤çš„åšå®¢æ–‡ç« ï¼ˆéœ€è¦ä¸€ä¸ªè½¯åˆ é™¤æ–‡ç« çš„åˆ—è¡¨ï¼‰ï¼Œä½†æ˜¯ç”¨æˆ·ä¸èƒ½ç¼–è¾‘åˆ é™¤çš„æ–‡ç« ã€‚

- **æˆ‘ä»ç„¶å¯ä»¥ `è¿æ¥` æˆ– `è¿æ¥æˆ–åˆ›å»º` å·²åˆ é™¤çš„å¸–å­å—ï¼Ÿ**<br/>

åœ¨è¿™ä¸ªä¾‹å­ä¸­ - æ˜¯çš„ã€‚ä¸­é—´ä»¶ä¸ä¼šé˜»æ­¢ä½ å°†ç°æœ‰çš„è½¯åˆ é™¤å¸–å­è¿æ¥åˆ°ç”¨æˆ·ã€‚

è¿è¡Œä»¥ä¸‹ç¤ºä¾‹ä»¥æŸ¥çœ‹ä¸­é—´ä»¶å¦‚ä½•å½±å“æ¯ä¸ªæŸ¥è¯¢ï¼š

```ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient({})

async function main() {
  /***********************************/
  /* SOFT DELETE MIDDLEWARE */
  /***********************************/

  prisma.$use(async (params, next) => {
    if (params.model == 'Post') {
      if (params.action == 'findUnique') {
        // æ›´æ”¹ä¸º findFirst - æ— æ³•è¿‡æ»¤
        // é™¤ ID / unique å’Œ findUnique ä¹‹å¤–çš„ä»»ä½•å†…å®¹
        params.action = 'findFirst'
        // æ·»åŠ  'deleted' è¿‡æ»¤å™¨
        // ä¿æŒ ID è¿‡æ»¤å™¨ 
        params.args.where['deleted'] = false
      }
      if (params.action == 'findMany') {
        // æŸ¥æ‰¾è®¸å¤šæŸ¥è¯¢
        if (params.args.where != undefined) {
          if (params.args.where.deleted == undefined) {
            // å¦‚æœæœªæ˜ç¡®è¦æ±‚åˆ é™¤è®°å½•ï¼Œåˆ™å°†å…¶æ’é™¤åœ¨å¤–
            params.args.where['deleted'] = false
          }
        } else {
          params.args['where'] = { deleted: false }
        }
      }
    }
    return next(params)
  })

  prisma.$use(async (params, next) => {
    if (params.model == 'Post') {
      if (params.action == 'update') {
        // æ›´æ”¹ä¸º updateMany - æ— æ³•è¿‡æ»¤
        // é™¤ ID / unique å’Œ findUnique ä¹‹å¤–çš„ä»»ä½•å†…å®¹
        params.action = 'updateMany'
        // æ·»åŠ  'deleted' è¿‡æ»¤å™¨
        // ä¿æŒ ID è¿‡æ»¤å™¨ 
        params.args.where['deleted'] = false
      }
      if (params.action == 'updateMany') {
        if (params.args.where != undefined) {
          params.args.where['deleted'] = false
        } else {
          params.args['where'] = { deleted: false }
        }
      }
    }
    return next(params)
  })

  prisma.$use(async (params, next) => {
    // æ£€æŸ¥ä¼ å…¥æŸ¥è¯¢ç±»å‹
    if (params.model == 'Post') {
      if (params.action == 'delete') {
        // åˆ é™¤æŸ¥è¯¢
        // å°†æ“ä½œæ›´æ”¹ä¸ºæ›´æ–°
        params.action = 'update'
        params.args['data'] = { deleted: true }
      }
      if (params.action == 'deleteMany') {
        // åˆ é™¤è®¸å¤šæŸ¥è¯¢
        params.action = 'updateMany'
        if (params.args.data != undefined) {
          params.args.data['deleted'] = true
        } else {
          params.args['data'] = { deleted: true }
        }
      }
    }
    return next(params)
  })

  /***********************************/
  /* æµ‹è¯• */
  /***********************************/

  const titles = [
    { title: 'How to create soft delete middleware' },
    { title: 'How to install Prisma' },
    { title: 'How to update a record' },
  ]

  console.log('\u001b[1;34mSTARTING SOFT DELETE TEST \u001b[0m')
  console.log('\u001b[1;34m#################################### \u001b[0m')

  let i = 0
  let posts = new Array()

  // æ¯æ¬¡åˆ›å»º 3 ç¯‡å¸¦æœ‰éšæœºåˆ†é…æ ‡é¢˜çš„æ–°å¸–å­
  for (i == 0; i < 3; i++) {
    const createPostOperation = prisma.post.create({
      data: titles[Math.floor(Math.random() * titles.length)],
    })
    posts.push(createPostOperation)
  }

  var postsCreated = await prisma.$transaction(posts)

  console.log(
    'Posts created with IDs: ' +
      '\u001b[1;32m' +
      postsCreated.map((x) => x.id) +
      '\u001b[0m'
  )

  // ä»æ•°ç»„ä¸­åˆ é™¤ç¬¬ä¸€ç¯‡æ–‡ç« 
  const deletePost = await prisma.post.delete({
    where: {
      id: postsCreated[0].id, // éšæœº ID
    },
  })

  // åˆ é™¤åä¸¤ä¸ªå¸–å­
  const deleteManyPosts = await prisma.post.deleteMany({
    where: {
      id: {
        in: [postsCreated[1].id, postsCreated[2].id],
      },
    },
  })

  const getOnePost = await prisma.post.findUnique({
    where: {
      id: postsCreated[0].id,
    },
  })

  const getPosts = await prisma.post.findMany({
    where: {
      id: {
        in: postsCreated.map((x) => x.id),
      },
    },
  })

  const getPostsAnDeletedPosts = await prisma.post.findMany({
    where: {
      id: {
        in: postsCreated.map((x) => x.id),
      },
      deleted: true,
    },
  })

  const updatePost = await prisma.post.update({
    where: {
      id: postsCreated[1].id,
    },
    data: {
      title: 'This is an updated title (update)',
    },
  })

  const updateManyDeletedPosts = await prisma.post.updateMany({
    where: {
      deleted: true,
      id: {
        in: postsCreated.map((x) => x.id),
      },
    },
    data: {
      title: 'This is an updated title (updateMany)',
    },
  })

  console.log()

  console.log(
    'Deleted post (delete) with ID: ' +
      '\u001b[1;32m' +
      deletePost.id +
      '\u001b[0m'
  )
  console.log(
    'Deleted posts (deleteMany) with IDs: ' +
      '\u001b[1;32m' +
      [postsCreated[1].id + ',' + postsCreated[2].id] +
      '\u001b[0m'
  )
  console.log()
  console.log(
    'findUnique: ' +
      (getOnePost?.id != undefined
        ? '\u001b[1;32m' + 'Posts returned!' + '\u001b[0m'
        : '\u001b[1;31m' +
          'Post not returned!' +
          '(Value is: ' +
          JSON.stringify(getOnePost) +
          ')' +
          '\u001b[0m')
  )
  console.log(
    'findMany: ' +
      (getPosts.length == 3
        ? '\u001b[1;32m' + 'Posts returned!' + '\u001b[0m'
        : '\u001b[1;31m' + 'Posts not returned!' + '\u001b[0m')
  )
  console.log(
    'findMany ( delete: true ): ' +
      (getPostsAnDeletedPosts.length == 3
        ? '\u001b[1;32m' + 'Posts returned!' + '\u001b[0m'
        : '\u001b[1;31m' + 'Posts not returned!' + '\u001b[0m')
  )
  console.log()
  console.log(
    'update: ' +
      (updatePost.id != undefined
        ? '\u001b[1;32m' + 'Post updated!' + '\u001b[0m'
        : '\u001b[1;31m' +
          'Post not updated!' +
          '(Value is: ' +
          JSON.stringify(updatePost) +
          ')' +
          '\u001b[0m')
  )
  console.log(
    'updateMany ( delete: true ): ' +
      (updateManyDeletedPosts.count == 3
        ? '\u001b[1;32m' + 'Posts updated!' + '\u001b[0m'
        : '\u001b[1;31m' + 'Posts not updated!' + '\u001b[0m')
  )
  console.log()
  console.log('\u001b[1;34m#################################### \u001b[0m')
  // 4. ç»Ÿè®¡æ‰€æœ‰å¸–å­
  const f = await prisma.post.findMany({})
  console.log(
    'Number of active posts: ' + '\u001b[1;32m' + f.length + '\u001b[0m'
  )

  // 5. ç»Ÿè®¡æ‰€æœ‰å·²åˆ é™¤çš„å¸–å­
  const r = await prisma.post.findMany({
    where: {
      deleted: true,
    },
  })
  console.log(
    'Number of SOFT deleted posts: ' + '\u001b[1;32m' + r.length + '\u001b[0m'
  )
}

main()
```

è¯¥ç¤ºä¾‹è¾“å‡ºä»¥ä¸‹å†…å®¹ï¼š

```
STARTING SOFT DELETE TEST
####################################
Posts created with IDs: 680,681,682

Deleted post (delete) with ID: 680
Deleted posts (deleteMany) with IDs: 681,682

findUnique: Post not returned!(Value is: [])
findMany: Posts not returned!
findMany ( delete: true ): Posts returned!

update: Post not updated!(Value is: {"count":0})
updateMany ( delete: true ): Posts not updated!

####################################
Number of active posts: 0
Number of SOFT deleted posts: 95
```

âœ” è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹ï¼š

- å¼€å‘äººå‘˜å¯ä»¥æœ‰æ„è¯†åœ°é€‰æ‹©å°†å·²åˆ é™¤çš„è®°å½•åŒ…å«åœ¨ `findMany` ä¸­

- ä¸èƒ½æ„å¤–è¯»å–æˆ–æ›´æ–°å·²åˆ é™¤çš„è®°å½•

âœ– è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹ï¼š

-ä» API ä¸­ä¸æ˜æ˜¾çœ‹å‡ºä½ æ²¡æœ‰è·å¾—æ‰€æœ‰è®°å½•ï¼Œå¹¶ä¸” `{ where: { deleted: false } }` æ˜¯é»˜è®¤æŸ¥è¯¢çš„ä¸€éƒ¨åˆ†

-è¿”å›ç±»å‹ `update` å—å½±å“ï¼Œå› ä¸ºä¸­é—´ä»¶å°†æŸ¥è¯¢æ›´æ”¹ä¸º `updateMany`

## å¸¸è§é—®é¢˜

### æˆ‘æ˜¯å¦å¯ä»¥å°†å…¨å±€<inlinecode>includeDeleted</inlinecode>æ·»åŠ åˆ°<inlinecode>Post</inlinecode>æ¨¡å‹ï¼Ÿ

ä½ å¯èƒ½ä¼šè¯•å›¾é€šè¿‡å‘ `Post` æ¨¡å‹æ·»åŠ  `includedDeleted` å±æ€§æ¥ 'ç ´è§£' APIï¼Œå¹¶ä½¿ä»¥ä¸‹æŸ¥è¯¢æˆä¸ºå¯èƒ½ï¼š

```ts

prisma.post.findManyï¼ˆ{where:{includeDeleted:true}}ï¼‰

```

> **æ³¨æ„**ï¼šä½ ä»ç„¶éœ€è¦ç¼–å†™ä¸­é—´ä»¶ã€‚

æˆ‘ä»¬ **âœ˜ ä¸è¦** æ¨èè¿™ç§æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¼šç”¨ä¸ä»£è¡¨çœŸå®æ•°æ®çš„å­—æ®µæ±¡æŸ“ schemaã€‚